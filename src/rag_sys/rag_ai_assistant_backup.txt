#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
RAGæ™ºèƒ½æ•™å­¸åŠ©ç†æœå‹™ - Backendæ•´åˆç‰ˆæœ¬
æä¾›å®Œæ•´çš„RAGæ™ºèƒ½æ•™å­¸åŠŸèƒ½ï¼ŒåŒ…æ‹¬å•ç­”ã€å¼•å°æ•™å­¸å’Œå­¸ç¿’åˆ†æ
"""

import os
import sys
import json
import logging
from pathlib import Path
from typing import Dict, List, Any, Optional
from datetime import datetime
from flask import Blueprint, request, jsonify, session
from functools import wraps

# å°å…¥RAGç³»çµ±æ¨¡çµ„
try:
    # å˜—è©¦å¾rag_sysåŒ…å°å…¥
    from .rag_sys.config import *
    from .rag_sys.rag_processor import RAGProcessor
    from .rag_sys.rag_ai_responder import AIResponder
    from .rag_sys.multi_ai_tutor import MultiAITutor

    RAG_AVAILABLE = True
    print("âœ… æˆåŠŸå°å…¥RAGç³»çµ±æ¨¡çµ„")

except ImportError as e:
    print(f"âš ï¸ RAGç³»çµ±æ¨¡çµ„å°å…¥å¤±æ•—: {e}")
    print("ğŸ’¡ ä½¿ç”¨ç°¡åŒ–æ¨¡å¼")

    # ç°¡åŒ–çš„æ¨¡æ“¬é¡
    class MockRAGProcessor:
        def __init__(self, *args, **kwargs):
            self.initialized = False

    class MockAIResponder:
        def __init__(self, *args, **kwargs):
            pass

        def answer_question(self, question):
            # ç°¡å–®çš„å•é¡Œåˆ†é¡
            question_lower = question.lower()
            if any(word in question_lower for word in ['ä½ å¥½', 'è‡ªæˆ‘ä»‹ç´¹', 'ä½ æ˜¯èª°', 'ä»‹ç´¹', 'è¬è¬']):
                return {
                    "è©³ç´°å›ç­”": f"æ‚¨å¥½ï¼æˆ‘æ˜¯è³‡ç®¡ç³»æ™ºèƒ½æ•™å­¸åŠ©ç†ã€‚é—œæ–¼ã€Œ{question}ã€ï¼Œæˆ‘å¾ˆæ¨‚æ„ç‚ºæ‚¨ä»‹ç´¹ã€‚æˆ‘å°ˆé–€å”åŠ©å­¸ç”Ÿå­¸ç¿’è³‡è¨Šç®¡ç†ç›¸é—œçŸ¥è­˜ï¼ŒåŒ…æ‹¬ä½œæ¥­ç³»çµ±ã€è³‡æ–™åº«ã€ç¶²è·¯ç­‰é ˜åŸŸã€‚æœ‰ä»€éº¼è³‡ç®¡å•é¡Œæƒ³è¦è¨è«–å—ï¼Ÿ",
                    "å•é¡Œé¡å‹": "éå­¸è¡“å•é¡Œ"
                }
            else:
                return {
                    "è©³ç´°å›ç­”": f"é—œæ–¼ã€Œ{question}ã€çš„å›ç­”ï¼šé€™æ˜¯ä¸€å€‹é‡è¦çš„æ¦‚å¿µï¼Œå»ºè­°æŸ¥é–±ç›¸é—œæ•™ææ·±å…¥å­¸ç¿’ã€‚",
                    "å•é¡Œé¡å‹": "å­¸è¡“å•é¡Œ"
                }

        def format_response_for_display(self, response):
            if isinstance(response, dict) and 'è©³ç´°å›ç­”' in response:
                return response['è©³ç´°å›ç­”']
            elif isinstance(response, dict) and 'answer' in response:
                return response['answer']
            return str(response)

    class MockMultiAITutor:
        def __init__(self, *args, **kwargs):
            pass

        def start_new_question(self, question):
            return f"ğŸ“ é—œæ–¼ã€Œ{question}ã€çš„å¼•å°æ•™å­¸ï¼šè®“æˆ‘å€‘ä¸€æ­¥æ­¥ä¾†æ¢è¨é€™å€‹æ¦‚å¿µã€‚æ‚¨å°æ­¤æœ‰ä»€éº¼åˆæ­¥äº†è§£å—ï¼Ÿ"

        def continue_conversation(self, answer):
            return "å¾ˆå¥½çš„å›ç­”ï¼è®“æˆ‘å€‘ç¹¼çºŒæ·±å…¥æ¢è¨ã€‚æ‚¨é‚„æœ‰å…¶ä»–æƒ³æ³•å—ï¼Ÿ"

        def reset(self):
            pass

    # åŸºæœ¬é…ç½®
    EMBEDDING_MODEL = "paraphrase-multilingual-MiniLM-L12-v2"
    LOGGING_CONFIG = {"level": "INFO", "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"}
    SEARCH_CONFIG = {"default_top_k": 5, "similarity_threshold": 0.3}
    AI_CONFIG = {"temperature": 0.7, "max_tokens": 500}

    RAGProcessor = MockRAGProcessor
    AIResponder = MockAIResponder
    MultiAITutor = MockMultiAITutor
    RAG_AVAILABLE = False

# è¨­å®šæ—¥èªŒ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# å‰µå»ºBlueprint
rag_assistant_bp = Blueprint('rag_assistant', __name__, url_prefix='/rag_assistant')

class RAGAssistantService:
    """RAGæ™ºèƒ½æ•™å­¸åŠ©ç†æœå‹™"""
    
    def __init__(self):
        """åˆå§‹åŒ–æœå‹™"""
        self.tutors = {}  # å­˜å„²æ¯å€‹ç”¨æˆ¶çš„tutorå¯¦ä¾‹
        self.processors = {}  # å­˜å„²æ¯å€‹ç”¨æˆ¶çš„processorå¯¦ä¾‹
        self.user_sessions = {}  # å­˜å„²ç”¨æˆ¶æœƒè©±æ•¸æ“š
        self.conversation_histories = {}  # å­˜å„²å°è©±æ­·å²
        
        # åˆå§‹åŒ–RAGè™•ç†å™¨ï¼ˆå…±äº«ï¼‰
        if RAG_AVAILABLE:
            try:
                self.shared_processor = RAGProcessor(verbose=False, use_gpu=True)
                self.shared_ai_responder = AIResponder(
                    language='chinese',
                    rag_processor=self.shared_processor
                )
                logger.info("âœ… RAGç³»çµ±åˆå§‹åŒ–æˆåŠŸ")
            except Exception as e:
                logger.error(f"âŒ RAGç³»çµ±åˆå§‹åŒ–å¤±æ•—: {e}")
                self.shared_processor = None
                self.shared_ai_responder = None
        else:
            logger.info("âš ï¸ RAGç³»çµ±ä¸å¯ç”¨ï¼Œä½¿ç”¨ç°¡åŒ–æ¨¡å¼")
            self.shared_processor = None
            self.shared_ai_responder = None
    
    def get_user_id(self) -> str:
        """ç²å–ç”¨æˆ¶IDï¼ˆå¾sessionæˆ–ç”Ÿæˆè‡¨æ™‚IDï¼‰"""
        if 'user_id' in session:
            return str(session['user_id'])
        else:
            # ç”Ÿæˆè‡¨æ™‚ç”¨æˆ¶ID
            temp_id = f"temp_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
            session['temp_user_id'] = temp_id
            return temp_id
    
    def get_user_session_data(self, user_id: str) -> Dict:
        """ç²å–ç”¨æˆ¶æœƒè©±æ•¸æ“š"""
        if user_id not in self.user_sessions:
            self.user_sessions[user_id] = {
                'current_ai_model': 'gemini',  # é è¨­ä½¿ç”¨Gemini
                'in_conversation': False,
                'conversation_count': 0,
                'last_activity': datetime.now().isoformat(),
                'user_profile': {
                    'learning_style': 'unknown',
                    'weak_topics': [],
                    'strong_topics': [],
                    'total_questions': 0,
                    'correct_answers': 0
                }
            }
        return self.user_sessions[user_id]
    
    def get_conversation_history(self, user_id: str) -> List[Dict]:
        """ç²å–ç”¨æˆ¶å°è©±æ­·å²"""
        if user_id not in self.conversation_histories:
            self.conversation_histories[user_id] = []
        return self.conversation_histories[user_id]
    
    def add_conversation_record(self, user_id: str, question: str, response: str, conversation_type: str = 'general'):
        """æ·»åŠ å°è©±è¨˜éŒ„"""
        history = self.get_conversation_history(user_id)
        record = {
            'timestamp': datetime.now().isoformat(),
            'question': question,
            'response': response,
            'type': conversation_type,
            'ai_model': self.get_user_session_data(user_id)['current_ai_model']
        }
        history.append(record)
        
        # é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
        if len(history) > 100:
            history.pop(0)
    
    def get_user_tutor(self, user_id: str) -> any:
        """ç²å–ç”¨æˆ¶çš„Geminiæ•™å­¸ç³»çµ±å¯¦ä¾‹"""
        if RAG_AVAILABLE:
            if user_id not in self.tutors:
                try:
                    self.tutors[user_id] = MultiAITutor(rag_processor=self.shared_processor)
                except Exception as e:
                    logger.error(f"âŒ å‰µå»ºGeminiæ•™å­¸ç³»çµ±å¤±æ•—: {e}")
                    return None
            return self.tutors[user_id]
        else:
            # ç°¡åŒ–æ¨¡å¼
            return MockMultiAITutor()
    
    def analyze_user_learning_data(self, user_id: str) -> Dict:
        """åˆ†æç”¨æˆ¶å­¸ç¿’æ•¸æ“š"""
        session_data = self.get_user_session_data(user_id)
        conversation_history = self.get_conversation_history(user_id)
        
        # åŸºæœ¬çµ±è¨ˆ
        total_conversations = len(conversation_history)
        recent_conversations = [c for c in conversation_history 
                              if (datetime.now() - datetime.fromisoformat(c['timestamp'])).days <= 7]
        
        # åˆ†æå•é¡Œé¡å‹
        question_types = {}
        for conv in conversation_history:
            q_type = self._classify_question_type(conv['question'])
            question_types[q_type] = question_types.get(q_type, 0) + 1
        
        # åˆ†æè–„å¼±é ˜åŸŸ
        weak_areas = self._identify_weak_areas(conversation_history)
        
        # è¨ˆç®—å­¸ç¿’é€²åº¦
        learning_progress = self._calculate_learning_progress(session_data, conversation_history)
        
        return {
            'learning_summary': {
                'total_conversations': total_conversations,
                'recent_activity': len(recent_conversations),
                'most_discussed_topics': list(question_types.keys())[:3],
                'preferred_question_types': list(question_types.keys())[:2],
                'learning_frequency': 'high' if total_conversations > 20 else 'medium' if total_conversations > 5 else 'low'
            },
            'question_analysis': question_types,
            'weak_areas': weak_areas,
            'learning_progress': learning_progress,
            'learning_recommendations': self._generate_learning_recommendations(session_data, conversation_history)
        }
    
    def _classify_question_type(self, question: str) -> str:
        """åˆ†é¡å•é¡Œé¡å‹"""
        question_lower = question.lower()
        
        if any(word in question_lower for word in ['ä»€éº¼æ˜¯', 'what is', 'å®šç¾©', 'definition']):
            return 'å®šç¾©é¡'
        elif any(word in question_lower for word in ['å¦‚ä½•', 'how to', 'æ€éº¼', 'æ–¹æ³•']):
            return 'æ–¹æ³•é¡'
        elif any(word in question_lower for word in ['ç‚ºä»€éº¼', 'why', 'åŸå› ', 'reason']):
            return 'åŸç†é¡'
        elif any(word in question_lower for word in ['æ¯”è¼ƒ', 'compare', 'å·®ç•°', 'difference']):
            return 'æ¯”è¼ƒé¡'
        elif any(word in question_lower for word in ['æ‡‰ç”¨', 'application', 'å¯¦ä¾‹', 'example']):
            return 'æ‡‰ç”¨é¡'
        else:
            return 'å…¶ä»–'
    
    def _identify_weak_areas(self, conversation_history: List[Dict]) -> List[str]:
        """è­˜åˆ¥è–„å¼±é ˜åŸŸ"""
        # ç°¡åŒ–çš„è–„å¼±é ˜åŸŸè­˜åˆ¥
        topic_counts = {}
        for conv in conversation_history:
            # åŸºæ–¼å•é¡Œå…§å®¹è­˜åˆ¥ä¸»é¡Œ
            question = conv['question'].lower()
            if 'ä½œæ¥­ç³»çµ±' in question or 'operating system' in question:
                topic_counts['ä½œæ¥­ç³»çµ±'] = topic_counts.get('ä½œæ¥­ç³»çµ±', 0) + 1
            elif 'è³‡æ–™åº«' in question or 'database' in question:
                topic_counts['è³‡æ–™åº«'] = topic_counts.get('è³‡æ–™åº«', 0) + 1
            elif 'ç¶²è·¯' in question or 'network' in question:
                topic_counts['ç¶²è·¯'] = topic_counts.get('ç¶²è·¯', 0) + 1
            elif 'ç¨‹å¼' in question or 'programming' in question:
                topic_counts['ç¨‹å¼è¨­è¨ˆ'] = topic_counts.get('ç¨‹å¼è¨­è¨ˆ', 0) + 1
        
        # å•é¡Œæ¬¡æ•¸å¤šçš„å¯èƒ½æ˜¯è–„å¼±é ˜åŸŸ
        weak_areas = [topic for topic, count in topic_counts.items() if count > 2]
        return weak_areas
    
    def _calculate_learning_progress(self, session_data: Dict, conversation_history: List[Dict]) -> Dict:
        """è¨ˆç®—å­¸ç¿’é€²åº¦"""
        total_conversations = len(conversation_history)
        
        # ç°¡åŒ–çš„é€²åº¦è¨ˆç®—
        if total_conversations < 5:
            level = "å…¥é–€"
            percentage = min(total_conversations * 10, 30)
        elif total_conversations < 15:
            level = "åˆç´š"
            percentage = 30 + (total_conversations - 5) * 5
        elif total_conversations < 30:
            level = "ä¸­ç´š"
            percentage = 60 + (total_conversations - 15) * 2
        else:
            level = "é€²éš"
            percentage = min(90 + (total_conversations - 30), 100)
        
        return {
            'level': level,
            'percentage': percentage,
            'total_interactions': total_conversations,
            'estimated_study_time': f"{total_conversations * 5} åˆ†é˜"
        }
    
    def _generate_learning_recommendations(self, session_data: Dict, conversation_history: List[Dict]) -> List[str]:
        """ç”Ÿæˆå­¸ç¿’å»ºè­°"""
        recommendations = []
        total_conversations = len(conversation_history)
        
        if total_conversations < 5:
            recommendations.append("å»ºè­°å¤šæå•ä¸åŒé¡å‹çš„å•é¡Œï¼Œæ“´å±•å­¸ç¿’ç¯„åœ")
            recommendations.append("å¯ä»¥å¾åŸºç¤æ¦‚å¿µé–‹å§‹ï¼Œé€æ­¥æ·±å…¥")
        elif total_conversations < 15:
            recommendations.append("å˜—è©¦æ›´æ·±å…¥çš„å•é¡Œï¼ŒæŒ‘æˆ°è‡ªå·±çš„ç†è§£")
            recommendations.append("å¯ä»¥å˜—è©¦å¯¦ä½œç·´ç¿’ï¼ŒåŠ æ·±ç†è§£")
        else:
            recommendations.append("è€ƒæ…®å­¸ç¿’æ›´é«˜ç´šçš„ä¸»é¡Œ")
            recommendations.append("å˜—è©¦å°‡ä¸åŒæ¦‚å¿µçµåˆï¼Œå»ºç«‹çŸ¥è­˜ç¶²çµ¡")
        
        return recommendations

    def _generate_learning_path(self, wrong_questions: List[Dict]) -> List[Dict]:
        """ç”Ÿæˆæ™ºèƒ½å­¸ç¿’è·¯å¾‘"""
        # ç°¡åŒ–çš„å­¸ç¿’è·¯å¾‘ç”Ÿæˆé‚è¼¯
        # å¯¦éš›æ‡‰ç”¨ä¸­å¯ä»¥æ ¹æ“šçŸ¥è­˜é»ã€é›£åº¦ã€éŒ¯èª¤é¡å‹ç­‰é€²è¡Œæ™ºèƒ½æ’åº

        # æŒ‰é›£åº¦å’ŒçŸ¥è­˜é»åˆ†çµ„
        grouped_questions = {}
        for question in wrong_questions:
            topic = question.get('topic', 'å…¶ä»–')
            if topic not in grouped_questions:
                grouped_questions[topic] = []
            grouped_questions[topic].append(question)

        # ç”Ÿæˆå­¸ç¿’è·¯å¾‘ï¼šå…ˆæ˜“å¾Œé›£ï¼ŒæŒ‰çŸ¥è­˜é»èšé¡
        learning_path = []
        for topic, questions in grouped_questions.items():
            # æŒ‰é›£åº¦æ’åºï¼ˆå¦‚æœæœ‰é›£åº¦è³‡è¨Šï¼‰
            sorted_questions = sorted(questions, key=lambda x: x.get('difficulty', 1))
            learning_path.extend(sorted_questions)

        return learning_path

# å…¨å±€æœå‹™å¯¦ä¾‹
rag_service = RAGAssistantService()

def require_rag_system(f):
    """è£é£¾å™¨ï¼šç¢ºä¿RAGç³»çµ±å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨å‰‡ä½¿ç”¨ç°¡åŒ–æ¨¡å¼"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        # ä¸å†é˜»æ­¢åŸ·è¡Œï¼Œè€Œæ˜¯è®“å‡½æ•¸è™•ç†RAGä¸å¯ç”¨çš„æƒ…æ³
        return f(*args, **kwargs)
    return decorated_function

# ==================== API ç«¯é» ====================

@rag_assistant_bp.route('/chat', methods=['POST'])
@require_rag_system
def chat_with_assistant():
    """èˆ‡AIåŠ©ç†å°è©±"""
    try:
        data = request.get_json()
        if not data:
            return jsonify({'success': False, 'error': 'ç„¡æ•ˆçš„è«‹æ±‚æ•¸æ“š'}), 400
        
        question = data.get('question', '').strip()
        if not question:
            return jsonify({'success': False, 'error': 'å•é¡Œä¸èƒ½ç‚ºç©º'}), 400
        
        ai_model = data.get('ai_model', 'gemini')
        conversation_type = data.get('type', 'general')
        
        user_id = rag_service.get_user_id()
        session_data = rag_service.get_user_session_data(user_id)
        
        # æ›´æ–°AIæ¨¡å‹é¸æ“‡
        if ai_model != session_data['current_ai_model']:
            session_data['current_ai_model'] = ai_model
        
        response_text = ""
        
        if conversation_type == 'tutoring':
            # ä½¿ç”¨æ•™å­¸æ¨¡å¼
            if RAG_AVAILABLE:
                tutor = rag_service.get_user_tutor(user_id)
                if tutor:
                    if not session_data['in_conversation']:
                        response_text = tutor.start_new_question(question)
                        session_data['in_conversation'] = True
                    else:
                        response_text = tutor.continue_conversation(question)
                else:
                    response_text = "æŠ±æ­‰ï¼ŒGeminiæ•™å­¸ç³»çµ±æš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚"
            else:
                # RAGç³»çµ±ä¸å¯ç”¨æ™‚çš„ç°¡åŒ–æ•™å­¸å›æ‡‰
                response_text = f"""
ğŸ“ **å¼•å°æ•™å­¸æ¨¡å¼**

é—œæ–¼æ‚¨çš„å•é¡Œã€Œ{question}ã€ï¼Œè®“æˆ‘å€‘ä¸€æ­¥æ­¥ä¾†æ¢è¨ï¼š

é€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„å•é¡Œï¼åœ¨å›ç­”ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆäº†è§£æ‚¨å°ç›¸é—œåŸºç¤æ¦‚å¿µçš„ç†è§£ã€‚

æ‚¨èƒ½å‘Šè¨´æˆ‘æ‚¨å°é€™å€‹ä¸»é¡Œå·²ç¶“äº†è§£å¤šå°‘å—ï¼Ÿé€™æ¨£æˆ‘å¯ä»¥æ›´å¥½åœ°å¼•å°æ‚¨å­¸ç¿’ã€‚

ğŸ’¡ **æç¤º**ï¼šä¸ç”¨æ“”å¿ƒç­”éŒ¯ï¼Œé€™æ˜¯å­¸ç¿’çš„éç¨‹ï¼å®Œæ•´çš„å¼•å°æ•™å­¸åŠŸèƒ½å°‡åœ¨RAGç³»çµ±é…ç½®å®Œæˆå¾Œæä¾›ã€‚
"""
        
        elif conversation_type == 'analysis':
            # ä½¿ç”¨åˆ†ææ¨¡å¼
            analysis_result = rag_service.analyze_user_learning_data(user_id)
            response_text = f"""
ğŸ“Š **å­¸ç¿’æˆæ•ˆåˆ†æå ±å‘Š**

**å­¸ç¿’æ¦‚æ³ï¼š**
â€¢ ç¸½å°è©±æ¬¡æ•¸ï¼š{analysis_result['learning_summary']['total_conversations']}
â€¢ è¿‘æœŸæ´»èºåº¦ï¼š{analysis_result['learning_summary']['recent_activity']} æ¬¡å°è©±
â€¢ å­¸ç¿’é »ç‡ï¼š{analysis_result['learning_summary']['learning_frequency']}

**å¸¸è¨è«–ä¸»é¡Œï¼š**
{', '.join(analysis_result['learning_summary']['most_discussed_topics']) if analysis_result['learning_summary']['most_discussed_topics'] else 'æš«ç„¡æ•¸æ“š'}

**å­¸ç¿’é€²åº¦ï¼š**
â€¢ ç­‰ç´šï¼š{analysis_result['learning_progress']['level']}
â€¢ é€²åº¦ï¼š{analysis_result['learning_progress']['percentage']}%
â€¢ é ä¼°å­¸ç¿’æ™‚é–“ï¼š{analysis_result['learning_progress']['estimated_study_time']}

**å­¸ç¿’å»ºè­°ï¼š**
{chr(10).join(f"â€¢ {rec}" for rec in analysis_result['learning_recommendations'])}

**éœ€è¦åŠ å¼·çš„é ˜åŸŸï¼š**
{', '.join(analysis_result['weak_areas']) if analysis_result['weak_areas'] else 'ç›®å‰è¡¨ç¾è‰¯å¥½ï¼'}
"""

        else:
            # ä½¿ç”¨ä¸€èˆ¬RAGå•ç­”æ¨¡å¼ - æ™ºèƒ½åˆ¤æ–·æ˜¯å¦ç‚ºå°è©±å»¶çºŒ
            if RAG_AVAILABLE:
                tutor = rag_service.get_user_tutor(user_id)
                if tutor:
                    # æª¢æŸ¥æ˜¯å¦ç‚ºå°è©±å»¶çºŒ
                    if session_data['in_conversation'] and hasattr(tutor, 'original_question') and tutor.original_question:
                        # é€™æ˜¯å°è©±çš„å»¶çºŒï¼Œä¸éœ€è¦é‡æ–°æŸ¥è©¢è³‡æ–™åº«
                        response_text = tutor.continue_conversation(question)
                    else:
                        response_text = tutor.start_new_question(question)
                        session_data['in_conversation'] = True
                else:
                    response_text = "æŠ±æ­‰ï¼ŒGeminiåŠ©ç†æš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚"
            else:
                # RAGç³»çµ±ä¸å¯ç”¨æ™‚çš„ç°¡åŒ–å›æ‡‰
                response_text = f"""
ğŸ“š **é—œæ–¼ã€Œ{question}ã€çš„å›ç­”**

é€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„å•é¡Œï¼ç”±æ–¼ç›®å‰RAGç³»çµ±æ­£åœ¨é…ç½®ä¸­ï¼Œæˆ‘å…ˆç‚ºæ‚¨æä¾›ä¸€å€‹åŸºæœ¬çš„å›ç­”æ¡†æ¶ï¼š

**æ¦‚å¿µè§£é‡‹ï¼š**
é€™å€‹æ¦‚å¿µåœ¨è³‡ç®¡ç³»èª²ç¨‹ä¸­æ˜¯ä¸€å€‹é‡è¦çš„ä¸»é¡Œï¼Œæ¶‰åŠåˆ°ç†è«–å’Œå¯¦å‹™çš„çµåˆã€‚

**é‡è¦ç‰¹é»ï¼š**
â€¢ å…·æœ‰ç³»çµ±æ€§çš„ç‰¹å¾µ
â€¢ åœ¨å¯¦éš›æ‡‰ç”¨ä¸­å¾ˆå¸¸è¦‹
â€¢ éœ€è¦ç†è§£å…¶åŸºæœ¬åŸç†

**å­¸ç¿’å»ºè­°ï¼š**
å»ºè­°æ‚¨å¯ä»¥å¾åŸºç¤æ¦‚å¿µé–‹å§‹ï¼Œé€æ­¥æ·±å…¥ç†è§£å…¶æ‡‰ç”¨å ´æ™¯ã€‚

ğŸ’¡ **æç¤º**ï¼šå®Œæ•´çš„RAGç³»çµ±é…ç½®å®Œæˆå¾Œï¼Œæˆ‘å°‡èƒ½æä¾›æ›´è©³ç´°å’Œæº–ç¢ºçš„å›ç­”ï¼
"""
        
        # è¨˜éŒ„å°è©±
        rag_service.add_conversation_record(user_id, question, response_text, conversation_type)
        
        # æ›´æ–°æœƒè©±æ•¸æ“š
        session_data['conversation_count'] += 1
        session_data['last_activity'] = datetime.now().isoformat()
        
        return jsonify({
            'success': True,
            'response': response_text,
            'conversation_type': conversation_type,
            'ai_model': ai_model,
            'conversation_count': session_data['conversation_count']
        })
    
    except Exception as e:
        logger.error(f"å°è©±è™•ç†éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'è™•ç†å°è©±æ™‚ç™¼ç”ŸéŒ¯èª¤',
            'message': str(e)
        }), 500

@rag_assistant_bp.route('/system-guide', methods=['POST'])
def get_system_guide():
    """ç²å–ç³»çµ±ä½¿ç”¨æŒ‡å—"""
    try:
        data = request.get_json()
        user_type = data.get('user_type', 'new') if data else 'new'

        if user_type == 'new':
            guide_text = """
ğŸ“ **æ­¡è¿ä½¿ç”¨è³‡ç®¡ç³»æ™ºèƒ½æ•™å­¸åŠ©ç†ï¼**

æˆ‘æ˜¯æ‚¨çš„å°ˆå±¬AIå­¸ç¿’å¤¥ä¼´ï¼Œå¯ä»¥å¹«åŠ©æ‚¨ï¼š

**ğŸ” æ™ºèƒ½å•ç­”**
â€¢ ç›´æ¥æå•ä»»ä½•è³‡ç®¡ç›¸é—œå•é¡Œ
â€¢ æ”¯æ´ä¸­è‹±æ–‡æ··åˆæŸ¥è©¢
â€¢ æä¾›è©³ç´°çš„æ¦‚å¿µè§£é‡‹å’Œå¯¦ä¾‹

**ğŸ“š å€‹æ€§åŒ–æ•™å­¸**
â€¢ æ ¹æ“šæ‚¨çš„å•é¡Œé€²è¡Œå¼•å°å¼æ•™å­¸
â€¢ æ¡ç”¨è˜‡æ ¼æ‹‰åº•å¼å°è©±æ–¹æ³•
â€¢ å¹«åŠ©æ‚¨æ·±å…¥ç†è§£æ¦‚å¿µ

**ğŸ“Š å­¸ç¿’åˆ†æ**
â€¢ åˆ†ææ‚¨çš„å­¸ç¿’æ¨¡å¼å’Œé€²åº¦
â€¢ è­˜åˆ¥è–„å¼±ç’°ç¯€ä¸¦æä¾›å»ºè­°
â€¢ è¿½è¹¤å­¸ç¿’æˆæ•ˆ

**ä½¿ç”¨æ–¹å¼ï¼š**
1. ç›´æ¥åœ¨å°è©±æ¡†ä¸­æå•
2. å¯ä»¥é¸æ“‡ä¸åŒçš„å°è©±æ¨¡å¼
3. éš¨æ™‚è¦æ±‚å­¸ç¿’åˆ†æå ±å‘Š

ç¾åœ¨å°±é–‹å§‹æå•å§ï¼ä¾‹å¦‚ï¼šã€Œä»€éº¼æ˜¯ä½œæ¥­ç³»çµ±ï¼Ÿã€

ğŸ’¡ **æ³¨æ„**ï¼šç³»çµ±æœƒæ ¹æ“šæ‚¨çš„å­¸ç¿’é€²åº¦æä¾›å€‹æ€§åŒ–å»ºè­°ï¼
"""
        else:
            guide_text = """
ğŸ‘‹ **æ­¡è¿å›ä¾†ï¼**

æ‚¨å¯ä»¥ï¼š
â€¢ ç¹¼çºŒä¹‹å‰çš„å­¸ç¿’ä¸»é¡Œ
â€¢ æå‡ºæ–°çš„å•é¡Œ
â€¢ è¦æ±‚åˆ†ææ‚¨çš„å­¸ç¿’é€²åº¦
â€¢ åˆ‡æ›ä¸åŒçš„å°è©±æ¨¡å¼

æœ‰ä»€éº¼æƒ³å­¸ç¿’çš„å—ï¼Ÿ
"""

        return jsonify({
            'success': True,
            'guide': guide_text,
            'user_type': user_type
        })

    except Exception as e:
        logger.error(f"ç³»çµ±æŒ‡å—éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'ç²å–ç³»çµ±æŒ‡å—æ™‚ç™¼ç”ŸéŒ¯èª¤'
        }), 500

@rag_assistant_bp.route('/learning-analysis', methods=['GET'])
def get_learning_analysis():
    """ç²å–å­¸ç¿’åˆ†æå ±å‘Š"""
    try:
        user_id = rag_service.get_user_id()
        analysis_result = rag_service.analyze_user_learning_data(user_id)

        return jsonify({
            'success': True,
            'analysis': analysis_result
        })

    except Exception as e:
        logger.error(f"å­¸ç¿’åˆ†æéŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'ç”Ÿæˆå­¸ç¿’åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤'
        }), 500



@rag_assistant_bp.route('/system-status', methods=['GET'])
def get_system_status():
    """ç²å–ç³»çµ±ç‹€æ…‹"""
    try:
        user_id = rag_service.get_user_id()
        session_data = rag_service.get_user_session_data(user_id)

        return jsonify({
            'success': True,
            'rag_system': {
                'processor_available': RAG_AVAILABLE and rag_service.shared_processor is not None,
                'ai_responder_available': RAG_AVAILABLE and rag_service.shared_ai_responder is not None
            },
            'tutor_system': {
                'tutor_initialized': RAG_AVAILABLE,
                'current_ai_model': session_data['current_ai_model'],
                'in_conversation': session_data['in_conversation']
            },
            'user_session': {
                'conversation_count': session_data['conversation_count'],
                'last_activity': session_data['last_activity']
            }
        })

    except Exception as e:
        logger.error(f"ç²å–ç³»çµ±ç‹€æ…‹éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'ç²å–ç³»çµ±ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤'
        }), 500

@rag_assistant_bp.route('/reset-conversation', methods=['POST'])
def reset_conversation():
    """é‡ç½®å°è©±ç‹€æ…‹"""
    try:
        user_id = rag_service.get_user_id()
        session_data = rag_service.get_user_session_data(user_id)

        # é‡ç½®å°è©±ç‹€æ…‹
        session_data['in_conversation'] = False

        # é‡ç½®æ•™å­¸ç³»çµ±
        tutor = rag_service.get_user_tutor(user_id)
        if tutor and hasattr(tutor, 'reset'):
            tutor.reset()

        return jsonify({
            'success': True,
            'message': 'å°è©±ç‹€æ…‹å·²é‡ç½®'
        })

    except Exception as e:
        logger.error(f"é‡ç½®å°è©±éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'é‡ç½®å°è©±æ™‚ç™¼ç”ŸéŒ¯èª¤'
        }), 500

@rag_assistant_bp.route('/conversation-history', methods=['GET'])
def get_conversation_history():
    """ç²å–å°è©±æ­·å²"""
    try:
        user_id = rag_service.get_user_id()
        history = rag_service.get_conversation_history(user_id)

        # é™åˆ¶è¿”å›æœ€è¿‘çš„å°è©±
        limit = request.args.get('limit', 20, type=int)
        recent_history = history[-limit:] if len(history) > limit else history

        return jsonify({
            'success': True,
            'history': recent_history,
            'total_count': len(history)
        })

    except Exception as e:
        logger.error(f"ç²å–å°è©±æ­·å²éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'ç²å–å°è©±æ­·å²æ™‚ç™¼ç”ŸéŒ¯èª¤'
        }), 500

# ==================== å­¸ç¿’ç³»çµ± API ç«¯é» ====================

@rag_assistant_bp.route('/submit-quiz-results', methods=['POST'])
def submit_quiz_results():
    """æäº¤æ¸¬é©—çµæœ"""
    try:
        data = request.get_json()
        if not data:
            return jsonify({'success': False, 'error': 'ç„¡æ•ˆçš„è«‹æ±‚æ•¸æ“š'}), 400

        user_id = rag_service.get_user_id()

        # é©—è­‰å¿…è¦æ¬„ä½
        required_fields = ['quiz_id', 'answers', 'submit_time', 'total_time']
        for field in required_fields:
            if field not in data:
                return jsonify({'success': False, 'error': f'ç¼ºå°‘å¿…è¦æ¬„ä½: {field}'}), 400

        # è™•ç†æ¸¬é©—çµæœ
        quiz_result = {
            'user_id': user_id,
            'quiz_id': data['quiz_id'],
            'answers': data['answers'],  # æ¯é“é¡Œçš„ç­”æ¡ˆå’Œçµæœ
            'submit_time': data['submit_time'],
            'total_time': data['total_time'],
            'score': data.get('score', 0),
            'total_questions': len(data['answers']),
            'correct_count': sum(1 for answer in data['answers'] if answer.get('is_correct', False)),
            'wrong_count': sum(1 for answer in data['answers'] if not answer.get('is_correct', True)),
            'marked_count': sum(1 for answer in data['answers'] if answer.get('is_marked', False)),
            'unanswered_count': sum(1 for answer in data['answers'] if answer.get('user_answer') is None)
        }

        # å„²å­˜åˆ°ç”¨æˆ¶æœƒè©±æ•¸æ“šä¸­ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰å„²å­˜åˆ°è³‡æ–™åº«ï¼‰
        session_data = rag_service.get_user_session_data(user_id)
        if 'quiz_results' not in session_data:
            session_data['quiz_results'] = []
        session_data['quiz_results'].append(quiz_result)

        # åˆ†æéŒ¯é¡Œ
        wrong_questions = [answer for answer in data['answers'] if not answer.get('is_correct', True)]

        return jsonify({
            'success': True,
            'result_id': f"result_{user_id}_{data['quiz_id']}_{data['submit_time']}",
            'summary': {
                'total_questions': quiz_result['total_questions'],
                'correct_count': quiz_result['correct_count'],
                'wrong_count': quiz_result['wrong_count'],
                'marked_count': quiz_result['marked_count'],
                'unanswered_count': quiz_result['unanswered_count'],
                'score': quiz_result['score'],
                'total_time': quiz_result['total_time']
            },
            'wrong_questions': wrong_questions,
            'message': 'æ¸¬é©—çµæœå·²æˆåŠŸæäº¤'
        })

    except Exception as e:
        logger.error(f"æäº¤æ¸¬é©—çµæœéŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'æäº¤æ¸¬é©—çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤',
            'message': str(e)
        }), 500

@rag_assistant_bp.route('/get-quiz-result/<result_id>', methods=['GET'])
def get_quiz_result(result_id):
    """ç²å–æ¸¬é©—çµæœè©³æƒ…"""
    try:
        user_id = rag_service.get_user_id()
        session_data = rag_service.get_user_session_data(user_id)

        # æŸ¥æ‰¾å°æ‡‰çš„æ¸¬é©—çµæœ
        quiz_results = session_data.get('quiz_results', [])
        target_result = None

        for result in quiz_results:
            if f"result_{result['user_id']}_{result['quiz_id']}_{result['submit_time']}" == result_id:
                target_result = result
                break

        if not target_result:
            return jsonify({'success': False, 'error': 'æ‰¾ä¸åˆ°æŒ‡å®šçš„æ¸¬é©—çµæœ'}), 404

        return jsonify({
            'success': True,
            'result': target_result
        })

    except Exception as e:
        logger.error(f"ç²å–æ¸¬é©—çµæœéŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'ç²å–æ¸¬é©—çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤'
        }), 500

@rag_assistant_bp.route('/start-error-learning', methods=['POST'])
def start_error_learning():
    """é–‹å§‹éŒ¯é¡Œå­¸ç¿’"""
    print("start_error_learning")   
    try:
        data = request.get_json()
        print(data)
        if not data:
            return jsonify({'success': False, 'error': 'ç„¡æ•ˆçš„è«‹æ±‚æ•¸æ“š'}), 400

        user_id = rag_service.get_user_id()
        result_id = data.get('result_id')
        print(user_id)
        print(result_id)
        if not result_id:
            return jsonify({'success': False, 'error': 'ç¼ºå°‘æ¸¬é©—çµæœID'}), 400

        # ç²å–æ¸¬é©—çµæœ
        session_data = rag_service.get_user_session_data(user_id)
        print(session_data)
        quiz_results = session_data.get('quiz_results', [])
        print(quiz_results)
        target_result = None

        for result in quiz_results:
            if f"result_{result['user_id']}_{result['quiz_id']}_{result['submit_time']}" == result_id:
                target_result = result
                break

        if not target_result:
            print("æ‰¾ä¸åˆ°æŒ‡å®šçš„æ¸¬é©—çµæœ")   
            return jsonify({'success': False, 'error': 'æ‰¾ä¸åˆ°æŒ‡å®šçš„æ¸¬é©—çµæœ'}), 404

        # æå–éŒ¯é¡Œ
        wrong_questions = [answer for answer in target_result['answers'] if not answer.get('is_correct', True)]
        print(wrong_questions)
        if not wrong_questions:
            return jsonify({
                'success': True,
                'message': 'æ­å–œï¼æ‚¨æ²’æœ‰éŒ¯é¡Œéœ€è¦å­¸ç¿’',
                'wrong_questions': []
            })

        # AI æ™ºèƒ½å®‰æ’å­¸ç¿’è·¯å¾‘
        learning_path = rag_service._generate_learning_path(wrong_questions)

        # å„²å­˜å­¸ç¿’æœƒè©±
        learning_session = {
            'session_id': f"learning_{user_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}",
            'user_id': user_id,
            'result_id': result_id,
            'wrong_questions': wrong_questions,
            'learning_path': learning_path,
            'current_question_index': 0,
            'completed_questions': [],
            'start_time': datetime.now().isoformat(),
            'status': 'active'
        }

        if 'learning_sessions' not in session_data:
            session_data['learning_sessions'] = []
        session_data['learning_sessions'].append(learning_session)

        return jsonify({
            'success': True,
            'session_id': learning_session['session_id'],
            'total_wrong_questions': len(wrong_questions),
            'learning_path': learning_path,
            'current_question': learning_path[0] if learning_path else None,
            'message': f'é–‹å§‹å­¸ç¿’ {len(wrong_questions)} é“éŒ¯é¡Œ'
        })

    except Exception as e:
        logger.error(f"é–‹å§‹éŒ¯é¡Œå­¸ç¿’éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'é–‹å§‹éŒ¯é¡Œå­¸ç¿’æ™‚ç™¼ç”ŸéŒ¯èª¤',
            'message': str(e)
        }), 500

@rag_assistant_bp.route('/ai-tutoring', methods=['POST'])
def ai_tutoring():
    """AI æ™ºèƒ½æ•™å­¸ - ç°¡åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥ä½¿ç”¨ç¾æœ‰çš„èŠå¤©åŠŸèƒ½"""
    try:
        data = request.get_json()
        if not data:
            return jsonify({'success': False, 'error': 'ç„¡æ•ˆçš„è«‹æ±‚æ•¸æ“š'}), 400

        user_id = rag_service.get_user_id()
        user_input = data.get('user_input', '')

        if not user_input:
            return jsonify({'success': False, 'error': 'ç¼ºå°‘ç”¨æˆ¶è¼¸å…¥'}), 400

        # ç›´æ¥ä½¿ç”¨ç¾æœ‰çš„èŠå¤©åŠŸèƒ½
        tutor = rag_service.get_user_tutor(user_id)
        if not tutor:
            return jsonify({'success': False, 'error': 'AI æ•™å­¸ç³»çµ±ä¸å¯ç”¨'}), 500

        # ä½¿ç”¨ MultiAITutor çš„èŠå¤©åŠŸèƒ½
        if RAG_AVAILABLE:
            response = tutor.continue_conversation(user_input)
        else:
            response = f"""
            æ„Ÿè¬æ‚¨çš„å•é¡Œï¼šã€Œ{user_input}ã€

            é€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„å•é¡Œã€‚è®“æˆ‘ç‚ºæ‚¨è©³ç´°è§£ç­”...

            æ‚¨é‚„æœ‰å…¶ä»–ç–‘å•å—ï¼Ÿ
            """

        return jsonify({
            'success': True,
            'response': response
        })

    except Exception as e:
        logger.error(f"AI æ•™å­¸éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'AI æ•™å­¸æ™‚ç™¼ç”ŸéŒ¯èª¤',
            'message': str(e)
        }), 500

@rag_assistant_bp.route('/learning-progress/<session_id>', methods=['GET'])
def get_learning_progress(session_id):
    """ç²å–å­¸ç¿’é€²åº¦"""
    try:
        user_id = rag_service.get_user_id()
        session_data = rag_service.get_user_session_data(user_id)

        # æŸ¥æ‰¾å­¸ç¿’æœƒè©±
        learning_sessions = session_data.get('learning_sessions', [])
        current_session = None

        for session in learning_sessions:
            if session['session_id'] == session_id:
                current_session = session
                break

        if not current_session:
            return jsonify({'success': False, 'error': 'æ‰¾ä¸åˆ°å­¸ç¿’æœƒè©±'}), 404

        total_questions = len(current_session['wrong_questions'])
        completed_questions = len(current_session['completed_questions'])
        current_index = current_session['current_question_index']

        progress_percentage = (completed_questions / total_questions * 100) if total_questions > 0 else 0

        return jsonify({
            'success': True,
            'progress': {
                'total_questions': total_questions,
                'completed_questions': completed_questions,
                'current_question_index': current_index,
                'progress_percentage': round(progress_percentage, 1),
                'remaining_questions': total_questions - completed_questions,
                'session_status': current_session['status']
            }
        })

    except Exception as e:
        logger.error(f"ç²å–å­¸ç¿’é€²åº¦éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'ç²å–å­¸ç¿’é€²åº¦æ™‚ç™¼ç”ŸéŒ¯èª¤'
        }), 500

@rag_assistant_bp.route('/complete-question-learning', methods=['POST'])
def complete_question_learning():
    """å®Œæˆå–®é¡Œå­¸ç¿’"""
    try:
        data = request.get_json()
        if not data:
            return jsonify({'success': False, 'error': 'ç„¡æ•ˆçš„è«‹æ±‚æ•¸æ“š'}), 400

        user_id = rag_service.get_user_id()
        session_id = data.get('session_id')
        question_id = data.get('question_id')
        understanding_level = data.get('understanding_level', 3)  # 1-5 ç†è§£ç¨‹åº¦

        if not session_id or not question_id:
            return jsonify({'success': False, 'error': 'ç¼ºå°‘å¿…è¦åƒæ•¸'}), 400

        # ç²å–å­¸ç¿’æœƒè©±
        session_data = rag_service.get_user_session_data(user_id)
        learning_sessions = session_data.get('learning_sessions', [])
        current_session = None

        for session in learning_sessions:
            if session['session_id'] == session_id:
                current_session = session
                break

        if not current_session:
            return jsonify({'success': False, 'error': 'æ‰¾ä¸åˆ°å­¸ç¿’æœƒè©±'}), 404

        # æ¨™è¨˜é¡Œç›®ç‚ºå·²å®Œæˆ
        completed_question = {
            'question_id': question_id,
            'completed_time': datetime.now().isoformat(),
            'understanding_level': understanding_level
        }

        current_session['completed_questions'].append(completed_question)
        current_session['current_question_index'] += 1

        # æª¢æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰é¡Œç›®
        if current_session['current_question_index'] >= len(current_session['wrong_questions']):
            current_session['status'] = 'completed'
            current_session['end_time'] = datetime.now().isoformat()

        # ç²å–ä¸‹ä¸€é¡Œ
        next_question = None
        if current_session['current_question_index'] < len(current_session['learning_path']):
            next_question = current_session['learning_path'][current_session['current_question_index']]

        return jsonify({
            'success': True,
            'message': 'é¡Œç›®å­¸ç¿’å®Œæˆ',
            'next_question': next_question,
            'session_completed': current_session['status'] == 'completed',
            'progress': {
                'completed': len(current_session['completed_questions']),
                'total': len(current_session['wrong_questions'])
            }
        })

    except Exception as e:
        logger.error(f"å®Œæˆé¡Œç›®å­¸ç¿’éŒ¯èª¤: {e}")
        return jsonify({
            'success': False,
            'error': 'å®Œæˆé¡Œç›®å­¸ç¿’æ™‚ç™¼ç”ŸéŒ¯èª¤'
        }), 500
