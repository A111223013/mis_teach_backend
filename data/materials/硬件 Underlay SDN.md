# 5-2 硬件 Underlay SDN

本章將深入探討「硬件 Underlay SDN」的核心概念、運作方式及其在現代網路基礎設施中的關鍵作用。我們將學習如何將軟體定義網路（SDN）的控制能力延伸至底層的物理硬體網路，以實現更高效、靈活且可程式化的網路管理。

## 1. 核心概念與定義

### 什麼是 Underlay 網路？

Underlay 網路（底層網路）是指提供資料傳輸實體路徑的基礎物理或邏輯網路。它包含了路由器、交換機、光纖、銅線等實際的網路設備和連接，負責將資料封包從一個點傳送到另一個點。Underlay 網路的核心職責是建立基本的連通性，確保所有網路節點都能互相通信。

#### 核心觀念
Underlay 網路是所有網路流量的基石，它提供資料包轉發的物理通路。其設計目標通常是高可用性、高頻寬和低延遲。

#### 例子
想像一個傳統的資料中心，所有的伺服器都透過實體交換機和纜線連接，這些交換機和纜線組成的網路就是 Underlay 網路。在 IP 網路中，BGP 或 OSPF 等路由協定負責在 Underlay 網路中建立和維護路由表。

### 什麼是 Overlay 網路？

Overlay 網路（疊加網路）是一種建構在 Underlay 網路之上的虛擬網路。它在 Underlay 網路的基礎上，透過隧道（Tunneling）技術（如 VXLAN, NVGRE, Geneve 等）來建立邏輯上的連通性，使不同的虛擬機器或容器可以互相通信，而無需 Underlay 網路感知這些虛擬網路的拓撲細節。

#### 核心觀念
Overlay 網路提供網路服務的彈性與隔離。它將應用程式的連通性與底層物理網路的複雜性解耦，使得應用程式可以更靈活地部署和遷移。

#### 例子
雲端運算環境中，租戶 A 的虛擬機器與租戶 B 的虛擬機器可能部署在同一台物理伺服器上，但它們分別屬於不同的虛擬網路。透過 VXLAN 等 Overlay 技術，即使它們使用相同的 Underlay 網路，它們的流量也是彼此隔離的。

### 什麼是 SDN？

軟體定義網路（Software-Defined Networking, SDN）是一種網路架構方法，旨在將網路的控制平面（Control Plane）與資料平面（Data Plane）解耦，並透過集中式的控制器來管理和配置網路設備。

#### 核心觀念
SDN 的核心思想是將網路智慧從分散的網路設備（如路由器、交換機）中抽離，集中到一個邏輯上集中的控制器。這使得網路可以像軟體一樣被程式化、自動化和靈活管理。

#### 例子
OpenFlow 是一種常見的 SDN 協定，它允許 SDN 控制器透過標準介面遠程地向交換機發送流表（Flow Table）指令，指示交換機如何處理特定的流量。

-----

### 什麼是 Hardware Underlay SDN？

Hardware Underlay SDN 是指將 SDN 的控制和可程式化能力直接應用於底層物理網路硬體，特別是網路交換機。與傳統的 Underlay 網路不同，Hardware Underlay SDN 的交換機不再僅僅是遵循硬編碼規則的設備，而是能夠接收 SDN 控制器的指令，根據軟體定義的策略動態地轉發流量。

#### 核心觀念
Hardware Underlay SDN 結合了 SDN 的靈活性和自動化能力，以及專用網路硬體（ASIC）提供的高效能、低延遲和高吞吐量。它允許網路營運商對物理網路的轉發行為進行精細且實時的控制，超越了傳統路由協定所能提供的彈性。

#### 與傳統網路的差異
| 特性         | 傳統 Underlay 網路           | Hardware Underlay SDN                 |
| :----------- | :--------------------------- | :------------------------------------ |
| **控制平面** | 分散式，設備獨立運作         | 集中式，由 SDN 控制器統一管理         |
| **資料平面** | 由設備自行決定轉發行為       | 依據控制器下發的流表進行轉發          |
| **配置方式** | 手動 CLI 或 SNMP             | 軟體程式化介面（API），自動化配置     |
| **靈活性**   | 較低，需逐一配置設備         | 高，可快速動態調整網路行為            |
| **效率**     | 受限於單設備處理能力         | 利用硬體高效能，但受限於控制器響應   |
| **可程式性** | 有限，基於固定功能晶片       | 高，可透過 OpenFlow, P4 等協定重新定義轉發邏輯 |

-----

## 2. 典型例子與轉換/推導

### Hardware Underlay SDN 的架構圖解

一個典型的 Hardware Underlay SDN 架構包括以下主要組件：

```mermaid
graph TD
    A[應用層 (Applications)] -->|RESTful API| B(SDN 控制器)
    B -->|OpenFlow/P4 Runtime| C1(可程式化交換機 1)
    B -->|OpenFlow/P4 Runtime| C2(可程式化交換機 2)
    B -->|OpenFlow/P4 Runtime| C3(可程式化交換機 N)
    C1 --- H1(主機 A)
    C2 --- H2(主機 B)
    C3 --- H3(主機 C)
    C1 <--> C2
    C1 <--> C3
    C2 <--> C3
```

*   **應用層 (Applications)：** 包含各種網路服務應用，例如流量工程、安全策略、負載平衡等。它們透過北向介面（Northbound API）與 SDN 控制器互動。
*   **SDN 控制器 (SDN Controller)：** 邏輯上集中的網路智慧中心。它維護網路的全局視圖，接收來自應用程式的請求，並將這些高階策略翻譯成底層設備能夠理解的指令。
*   **可程式化交換機 (Programmable Switches)：** 構成 Underlay 網路的物理硬體設備。這些交換機具有可程式化的資料平面，能夠根據 SDN 控制器下發的流表（Flow Table）或程式（P4）來處理和轉發資料封包。它們透過南向介面（Southbound API，如 OpenFlow 或 P4 Runtime）與控制器通信。
*   **主機 (Hosts)：** 連接到交換機的伺服器、虛擬機器等終端設備。

### 流量轉發流程 (Control Plane vs. Data Plane)

在 Hardware Underlay SDN 環境中，流量的轉發分為兩個主要階段：

1.  **控制平面操作 (Control Plane Operation - 策略下發)：**
    *   **步驟 1：應用請求。** 應用程式（例如，一個虛擬機管理系統）請求在網路中建立一條特定服務品質（QoS）的通道，將來自主機 A 的所有 HTTP 流量導向主機 B。
    *   **步驟 2：控制器接收。** SDN 控制器接收到這個高階請求。
    *   **步驟 3：路徑計算與策略翻譯。** 控制器根據其對網路拓撲的全局視圖，計算出一條最佳路徑（例如：從交換機 1 經過交換機 2 到交換機 3），並將高階策略翻譯成一系列精確的流表規則（或 P4 程式碼）。
    *   **步驟 4：流表下發。** 控制器透過南向介面（如 OpenFlow）將這些流表規則下發給路徑上的相關可程式化交換機（交換機 1, 2, 3）。每個規則會指定匹配條件（例如，源 IP、目的 IP、TCP 埠 80）和相應的動作（例如，轉發到特定埠、修改標頭、丟棄）。

2.  **資料平面操作 (Data Plane Operation - 封包轉發)：**
    *   **步驟 1：封包到達。** 主機 A 發送一個 HTTP 封包到達交換機 1。
    *   **步驟 2：流表匹配。** 交換機 1 的資料平面收到封包後，查詢其內部流表。它會找到控制器先前下發的匹配規則（例如，源 IP=A, 目的 IP=B, 埠=80）。
    *   **步驟 3：執行動作。** 根據匹配到的規則，交換機 1 執行指定的動作（例如，將封包轉發到連接交換機 2 的埠）。
    *   **步驟 4：沿路徑轉發。** 封包沿著控制器預設的路徑，依次經過交換機 2 和交換機 3，每個交換機都根據其流表規則高效地轉發封包，最終到達主機 B。

#### 推導：從靜態轉發到動態可程式化
傳統網路的轉發依賴於設備本地的路由表和 MAC 表，這些表通常由分散式協定（如 OSPF, BGP, STP）或手動配置生成，更新速度慢且缺乏全局視圖。

Hardware Underlay SDN 的引入，將「決策」與「執行」分開：
*   **決策（Control Plane）：** 由 SDN 控制器負責，擁有全局資訊，可以做出最佳的路由和轉發決策。
*   **執行（Data Plane）：** 由交換機硬體負責，根據控制器下發的指令高效執行轉發。

這種分離使得網路行為可以被軟體動態定義和調整，極大地提高了網路的彈性、可控性和自動化程度。

### 如何實現可程式化控制（e.g., OpenFlow, P4）

#### OpenFlow
OpenFlow 是最早且最廣泛採用的 SDN 南向介面協定之一。它定義了一種標準方式，允許控制器遠程管理交換機的流表。

*   **機制：** OpenFlow 交換機內部有一個或多個流表。每個流表項包含：
    *   **匹配欄位 (Match Fields)：** 用於匹配封包頭部的各種欄位（如 MAC, IP, 埠號等）。
    *   **優先級 (Priority)：** 決定流表項的匹配順序。
    *   **計數器 (Counters)：** 統計匹配到的封包數量和位元組數。
    *   **指令 (Instructions)：** 執行動作集（Action Set）或跳轉到另一個流表。
    *   **動作 (Actions)：** 對封包執行的具體操作，如轉發到特定埠、修改封包頭、丟棄等。
*   **控制器作用：** SDN 控制器透過 OpenFlow 協定向交換機下發、修改或刪除這些流表項，從而控制封包的轉發行為。

#### P4 (Programming Protocol-independent Packet Processors)
P4 是一種專門用於網路設備的可程式化資料平面描述語言。它允許網路工程師或設備製造商定義封包如何被解析、匹配、處理和轉發，而無需依賴於固定的協定。

*   **機制：** P4 程式會被編譯成特定硬體（如可程式化 ASIC 或 FPGA）能夠執行的微指令集。它定義了資料平面的「Parser」（如何解析封包頭）、一系列「Match-Action Tables」（類似 OpenFlow 流表，但更靈活）、以及「Deparser」（如何重新組裝封包）。
*   **與 OpenFlow 的差異：**
    *   **OpenFlow：** 定義了標準化的轉發流程和預設的匹配欄位。它使網路「可配置」。
    *   **P4：** 允許完全重新定義轉發邏輯和匹配欄位。它使網路「可程式化」，甚至可以處理未來未知協定或自定義協定。
*   **控制器作用：** 在 P4 環境中，SDN 控制器（或 P4 Runtime）不再是下發固定格式的流表，而是可以直接下發 P4 程式碼或控制 P4 程式中定義的 Match-Action 表的內容。這提供了前所未有的靈活性。

-----

## 3. 與相鄰概念的關聯

### 與 Overlay SDN 的關係

Hardware Underlay SDN 與 Overlay SDN 是互補的關係，而非替代。

*   **Underlay SDN (物理網路可程式化)：** 負責優化底層物理網路的效能、可靠性和資源利用率。它提供高效能的資料轉發基礎。
*   **Overlay SDN (虛擬網路彈性)：** 負責提供網路服務的彈性、多租戶隔離和應用程式遷移能力。它在 Underlay 之上建立邏輯網路。

在現代資料中心和雲端環境中，兩者通常結合使用：
*   **Underlay：** 採用 Hardware Underlay SDN 來實現高效能、低延遲的物理連通性，並能對物理流量進行細粒度監控和控制。
*   **Overlay：** 在此基礎上，透過隧道技術（如 VXLAN）建立多個邏輯虛擬網路，為不同的租戶或應用程式提供隔離的網路環境，並實現虛擬機器的靈活部署與遷移。

### 與 OpenFlow 的關係

OpenFlow 是實現 Hardware Underlay SDN 的一個重要協定，它為 SDN 控制器與可程式化交換機之間提供了一種標準的南向介面。早期，許多支援 SDN 的交換機都支援 OpenFlow。然而，隨著網路需求的演進，OpenFlow 的固定功能限制逐漸顯現，因此 P4 等更具彈性的可程式化語言應運而生。

### 與 P4 可程式化網路的關係

P4 是 Hardware Underlay SDN 的一個進階實現。它將可程式化的粒度從流表規則層面提升到了資料平面程式碼層面。這意味著，不僅可以動態配置轉發規則，還可以動態定義新的封包處理協定、匹配欄位和動作，使得網路硬體能夠適應更多元的應用場景和未來的網路技術。許多最新的可程式化交換機（如 Barefoot Tofino）都支援 P4。

### 與網路虛擬化 (NFV) 的關係

網路功能虛擬化（Network Function Virtualization, NFV）是將傳統網路功能（如防火牆、負載平衡器、路由器等）從專用硬體中解耦，作為軟體應用程式運行在通用伺服器上。

*   **關係：** NFV 和 SDN 經常協同工作。SDN 提供自動化的網路配置和管理能力，為 NFV 虛擬網路功能的動態部署和服務鏈（Service Chaining）提供底層支援。Hardware Underlay SDN 進一步確保 NFV 虛擬功能之間的高效能、低延遲互聯。

### 與雲端資料中心網路的關係

Hardware Underlay SDN 在雲端資料中心中扮演著核心角色。

*   **高效能基礎：** 為虛擬機器和容器提供高頻寬、低延遲的物理網路基礎。
*   **自動化部署：** 配合雲平台（如 OpenStack, Kubernetes），實現網路服務的自動化部署和管理。
*   **流量工程：** 允許雲提供商對資料中心內的流量進行精細控制和優化，例如智慧路由、負載平衡，以應對微服務架構和巨量資料流量。
*   **多租戶隔離與管理：** 雖然 Overlay SDN 負責邏輯隔離，但 Hardware Underlay SDN 可以提供底層的流量標籤、監控和安全策略執行，以增強多租戶環境的安全性與效能。

-----

## 4. 進階內容

### 硬體加速技術在 Hardware Underlay SDN 中的應用

為了滿足巨量流量和低延遲的嚴苛要求，Hardware Underlay SDN 離不開專用硬體加速技術：

*   **ASIC (Application-Specific Integrated Circuit)：** 專為高速封包處理設計的積體電路。大部分商用網路交換機使用 ASIC 來實現線速（Line Rate）轉發。在 Hardware Underlay SDN 中，ASIC 晶片被設計成支援可程式化功能（如 OpenFlow 流表或 P4 程式）。
    *   **優點：** 極致的效能、低功耗、高密度。
    *   **例子：** Broadcom 的 Tomahawk/Trident 系列、Barefoot Networks (現 Intel) 的 Tofino 系列。
*   **FPGA (Field-Programmable Gate Array)：** 一種可程式化的邏輯晶片，允許設計者在製造後重新配置其內部電路。
    *   **優點：** 高度靈活性，可以根據需求客製化封包處理邏輯，適合快速原型開發和專用功能。
    *   **缺點：** 相較於 ASIC，通常成本更高，功耗也可能更高，處理速度可能略低。
*   **網路處理器 (Network Processors, NPUs)：** 介於通用 CPU 和 ASIC 之間。它們通常由多個處理單元組成，可以並行處理封包。
    *   **優點：** 比 ASIC 更靈活，比通用 CPU 效率更高。
    *   **應用：** 複雜的封包處理功能，例如深度封包檢測 (DPI)。

### 可程式化交換機的發展

傳統交換機使用固定功能的 ASIC，其轉發邏輯在出廠時就已固化。可程式化交換機則允許使用者在一定程度上或完全地定義其資料平面的行為。

*   **第一代可程式化：** 主要透過 OpenFlow 協定來修改交換機內部的流表，控制轉發行為。功能受到 OpenFlow 協定定義的匹配和動作集合的限制。
*   **第二代可程式化 (P4 驅動)：** 以 P4 語言為代表，允許使用者定義全新的封包頭格式、匹配欄位和轉發邏輯。這使得交換機不僅能「轉發」，還能執行更複雜的網路功能，例如：
    *   **自定義遙測：** 嵌入網路狀態資訊到封包中。
    *   **協定創新：** 支援新的協定或優化現有協定。
    *   **網路內計算 (In-band Network Telemetry, INT)：** 在封包轉發路徑中即時收集網路遙測數據。

### Telemetry 與網路監控

Hardware Underlay SDN 的可程式化特性為網路監控和遙測（Telemetry）帶來了革命性的改變。

*   **傳統監控：** 主要依賴 SNMP、NetFlow/IPFIX 等，數據粒度粗，採樣頻率低，實時性差。
*   **SDN 遙測：**
    *   **流表計數器：** SDN 控制器可以實時查詢交換機流表中的計數器，獲取精確的流量統計。
    *   **In-band Network Telemetry (INT)：** 透過 P4 等語言，可以在每個交換機的資料平面為封包附加網路狀態資訊（如時間戳、埠利用率、隊列深度等），隨封包一起傳輸到目的地或監控點，實現毫秒級甚至微秒級的精確遙測。
    *   **主動探測：** 控制器可以注入特定的探測封包，並追蹤其路徑和延遲，實現主動式監控。

### 挑戰與未來趨勢

Hardware Underlay SDN 雖然帶來巨大潛力，但也面臨挑戰：

*   **擴展性 (Scalability)：** 大型網路中，SDN 控制器需要管理數千甚至數萬台交換機的流表，這對控制器的處理能力和狀態同步能力是巨大考驗。
*   **安全性 (Security)：** 集中式控制器成為攻擊目標，一旦被攻破，整個網路可能癱瘓。南向介面（OpenFlow/P4 Runtime）的安全性也至關重要。
*   **互通性 (Interoperability)：** 不同廠商的硬體和 SDN 軟體之間可能存在兼容性問題。需要標準化協定和介面。
*   **程式設計複雜度：** P4 等語言雖然強大，但也增加了網路工程師的學習曲線和程式設計複雜度。
*   **人才與生態：** 需要具備軟硬體整合知識的專業人才，以及更成熟的開發工具和生態系統。

**未來趨勢：**
*   **更深度的可程式化：** P4/P4C 等技術將持續發展，實現更細粒度的硬體控制。
*   **智慧化與 AI 整合：** 結合 AI/ML 演算法，實現網路的自我優化、故障預測和自動修復。
*   **邊緣運算網路：** 將 SDN 應用於邊緣數據中心和物聯網，實現低延遲、高可靠的邊緣網路服務。
*   **開放硬體與軟體：** 更多開源的 SDN 控制器、P4 工具鏈和白牌交換機方案。

-----

## 5. 常見錯誤與澄清

### 錯誤一：Hardware Underlay SDN 等於傳統網路

**澄清：** 儘管 Hardware Underlay SDN 使用物理硬體交換機，但它與傳統網路有根本區別。傳統網路中，交換機和路由器的控制邏輯是分散的、內置的，基於預設協定（如 STP, OSPF, BGP）。Hardware Underlay SDN 的核心是將控制平面集中化並軟體化，硬體僅作為資料平面的轉發器，其行為由中央控制器動態配置和管理。

### 錯誤二：Hardware Underlay SDN 和 Overlay SDN 是互相排斥的

**澄清：** 兩者是互補的。Hardware Underlay SDN 關注如何高效、靈活地管理物理網路資源，提供高性能的資料平面。Overlay SDN 則在此基礎上，透過隧道技術提供虛擬化、多租戶隔離的邏輯網路服務。在現代資料中心中，最佳實踐通常是結合使用兩者，Underlay 提供高效能物理基礎，Overlay 提供服務靈活性。

### 錯誤三：SDN 的「可程式化」意味著可以直接用 Python 等語言在交換機上寫程式

**澄清：** SDN 的「可程式化」通常指的是透過標準的南向介面（如 OpenFlow, P4 Runtime）或更低層次的程式設計語言（如 P4）來定義或配置網路設備的轉發行為。它不是指在交換機上運行通用的應用程式。P4 程式碼通常會被編譯成交換機 ASIC 的微指令集，這是一個高度專業化的過程，而非像在伺服器上執行 Python 腳本那樣通用。

-----

## 6. 小練習（附詳解）

### 小練習一：組件識別與功能匹配

請列出 Hardware Underlay SDN 架構中的三個核心組件，並簡要描述它們在流量轉發過程中的主要功能。

#### 詳解：

1.  **SDN 控制器 (SDN Controller)**
    *   **功能：** 作為網路的中央智慧核心。它維護網路的全局視圖，計算流量路徑，並將高階網路策略轉換為底層交換機可理解的流表規則（或 P4 程式），透過南向介面下發給交換機。
2.  **可程式化交換機 (Programmable Switch)**
    *   **功能：** 構成 Underlay 網路的物理硬體設備。它們負責資料平面的高速封包轉發。其轉發行為完全依賴於 SDN 控制器下發的流表（或 P4 程式）。當收到一個封包時，它會根據內部的流表規則進行匹配和執行相應的動作。
3.  **應用層 (Applications)**
    *   **功能：** 提供各種網路服務和業務邏輯。它們透過北向介面（API）向 SDN 控制器發出網路資源請求和策略指令，例如流量工程、安全策略、負載平衡等。

### 小練習二：流量路徑建立過程

假設您需要配置一個 Hardware Underlay SDN 網路，使得所有從 IP 地址 A 發往 IP 地址 B 的 HTTP (TCP 埠 80) 流量都必須經過交換機 `S1`、`S2`，最終到達目的主機。請描述這個流量路徑從策略定義到實際轉發的簡化流程。

#### 詳解：

1.  **需求定義：** 網路營運商或應用程式需要將來自 IP A 到 IP B 的 HTTP 流量導向特定路徑：`Host A` -> `S1` -> `S2` -> `Host B`。

2.  **應用層向控制器發出請求：**
    *   一個流量工程應用或管理平台透過北向 API 向 SDN 控制器發出指令，要求為 IP A 到 IP B 的 HTTP 流量建立一條經過 `S1` 和 `S2` 的路徑。

3.  **SDN 控制器進行路徑計算與策略翻譯：**
    *   控制器接收到請求，利用其儲存的網路拓撲資訊，確認 `S1` 和 `S2` 之間的連通性，並計算出從 `Host A` 所在交換機到 `S1`，再從 `S1` 到 `S2`，最終從 `S2` 到 `Host B` 所在交換機的完整物理路徑。
    *   控制器將這個高階策略翻譯成一系列具體的流表規則：
        *   **對 `S1`：** 匹配條件：源 IP=A, 目的 IP=B, TCP 埠=80。動作：將封包從 `Host A` 連接的埠轉發到連接 `S2` 的埠。
        *   **對 `S2`：** 匹配條件：源 IP=A, 目的 IP=B, TCP 埠=80。動作：將封包從連接 `S1` 的埠轉發到連接 `Host B` 的埠。

4.  **控制器下發流表規則：**
    *   控制器透過南向介面（如 OpenFlow 協定）將這些計算出的流表規則逐一下發到 `S1` 和 `S2` 這兩台可程式化交換機的資料平面。

5.  **資料平面執行封包轉發：**
    *   當 `Host A` 發送一個目標為 `Host B` 的 HTTP 封包時：
        *   封包首先到達 `S1`。
        *   `S1` 的資料平面查詢流表，匹配到 `源 IP=A, 目的 IP=B, TCP 埠=80` 的規則。
        *   `S1` 執行動作，將封包轉發到連接 `S2` 的埠。
        *   封包到達 `S2`。
        *   `S2` 的資料平面查詢流表，匹配到 `源 IP=A, 目的 IP=B, TCP 埠=80` 的規則。
        *   `S2` 執行動作，將封包轉發到連接 `Host B` 的埠。
        *   最終，封包成功抵達 `Host B`。

-----

## 7. 延伸閱讀/參考

*   **書籍：**
    *   "SDN: Software Defined Networks" by Thomas D. Nadeau and Ken Gray.
    *   "P4: Programming Protocol-Independent Packet Processors" by Pat Bosshart et al. (可以參考 P4 語言的官方網站和相關文檔)
*   **學術論文：**
    *   OpenFlow 相關的原始論文，例如 "OpenFlow: Enabling Innovation in Campus Networks" by Nick McKeown et al.
    *   P4 語言的定義和應用相關論文。
*   **標準與組織：**
    *   **Open Networking Foundation (ONF)：** 負責 OpenFlow 和其他 SDN 相關標準的制定。
    *   **P4.org：** P4 語言的官方組織，提供語言規範、編譯器和工具。
*   **網站與部落格：**
    *   Intel (Barefoot Networks) 關於 Tofino 晶片和 P4 的技術文檔。
    *   SDNLABS、P4 Blog 等社區和技術分享平台。