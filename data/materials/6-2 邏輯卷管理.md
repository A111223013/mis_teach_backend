# 6-2 邏輯卷管理 (Logical Volume Management, LVM)

---

### 什麼是邏輯卷管理 (LVM)？

#### 核心概念與定義

邏輯卷管理 (LVM) 是一種在 Linux 系統中廣泛使用的儲存抽象化技術。它允許系統管理員將多個物理硬碟或磁碟分割區組合成一個或多個「卷組 (Volume Group, VG)」，然後從這些卷組中劃分出「邏輯卷 (Logical Volume, LV)」。這些邏輯卷可以被格式化為檔案系統並掛載使用，就像傳統的磁碟分割區一樣。

**為什麼需要 LVM？**

傳統的磁碟分割區有其限制：一旦建立，其大小就固定了。如果需要擴大或縮小，往往需要重新規劃整個磁碟、備份資料、刪除舊分割區、建立新分割區、恢復資料，這個過程既複雜又高風險。LVM 則提供了解決方案：

1.  **彈性調整大小**：無需中斷服務，即可擴展或縮小邏輯卷及其上的檔案系統。
2.  **抽象化**：將物理儲存裝置與邏輯卷分離，系統無需知道資料存儲在哪個具體的物理磁碟上。
3.  **聚合多個磁碟**：可將多個物理磁碟或分割區合併成一個大型儲存池。
4.  **快照功能**：提供特定時間點的快照功能，便於備份或測試。
5.  **線上遷移**：可在不同物理裝置間遷移資料，無需停機。

**LVM 的核心元件：**

LVM 的運作基於以下三個主要概念：

1.  **物理卷 (Physical Volume, PV)**
    *   **定義**：物理卷是 LVM 系統的基礎構成單元。它可以是一個完整的物理硬碟、一個磁碟分割區，或是其他塊裝置（例如 RAID 陣列）。在使用前，這些裝置必須先經過 `pvcreate` 命令初始化，標記為 LVM 專用。
    *   **核心觀念**：PV 會被分割成固定大小的「物理區塊 (Physical Extents, PE)」，這是 LVM 空間管理的最小單位。
    *   **例子**：`/dev/sdb1`, `/dev/sdc`。

2.  **卷組 (Volume Group, VG)**
    *   **定義**：卷組是由一個或多個物理卷組成的儲存池。它是 LVM 中管理邏輯卷的容器。一個卷組可以包含來自不同物理磁碟的物理卷。
    *   **核心觀念**：VG 將其所包含的所有 PV 中的 PE 聚合起來，形成一個統一的儲存空間池。邏輯卷就是從這個池中分配出來的。
    *   **例子**：`my_vg`, `data_vg`。

3.  **邏輯卷 (Logical Volume, LV)**
    *   **定義**：邏輯卷是從卷組中劃分出來的，可供作業系統直接使用的虛擬磁碟分割區。它像傳統的分割區一樣，可以被格式化為檔案系統（例如 ext4, XFS）並掛載到目錄上。
    *   **核心觀念**：LV 由邏輯區塊 (Logical Extents, LE) 組成，一個 LE 對應一個 PE。邏輯卷的大小可以動態調整（擴展或縮小）。
    *   **例子**：`/dev/my_vg/my_lv`, `/dev/data_vg/web_data`。

-----

### 典型例子與操作推導

以下演示如何從零開始建立 LVM 結構，並進行常見的操作。

#### 1. 準備物理裝置

假設我們有兩個新的、未使用的磁碟：`/dev/sdb` 和 `/dev/sdc`。

```bash
# 確保磁碟沒有重要資料，因為 pvcreate 會抹除其上的 LVM 元數據
# 如果是分割區，例如 /dev/sdb1，也必須確保沒有重要資料。

# 建立物理卷 (PV)
sudo pvcreate /dev/sdb /dev/sdc
```

*   **說明**：`pvcreate` 命令會初始化指定的磁碟或分割區，並將它們標記為 LVM 物理卷。

#### 2. 建立卷組 (VG)

將已建立的物理卷加入到一個卷組中。

```bash
# 建立一個名為 'my_vg' 的卷組，包含 /dev/sdb 和 /dev/sdc
sudo vgcreate my_vg /dev/sdb /dev/sdc
```

*   **說明**：`vgcreate` 命令會建立一個新的卷組，並將指定的 PVs 添加進去。

#### 3. 建立邏輯卷 (LV)

從卷組中劃分出邏輯卷。

```bash
# 從 'my_vg' 卷組中建立一個名為 'my_lv'，大小為 10GB 的邏輯卷
sudo lvcreate -n my_lv -L 10G my_vg
```

*   **說明**：
    *   `-n my_lv`：指定邏輯卷的名稱為 `my_lv`。
    *   `-L 10G`：指定邏輯卷的大小為 10 Gigabytes。
    *   `my_vg`：指定要從哪個卷組中劃分。
*   **結果**：建立後，你會在 `/dev/my_vg/my_lv`（或 `/dev/mapper/my_vg-my_lv`）找到這個邏輯卷，它現在就像一個獨立的磁碟分割區。

#### 4. 格式化邏輯卷並掛載

```bash
# 格式化邏輯卷為 ext4 檔案系統
sudo mkfs.ext4 /dev/my_vg/my_lv

# 建立一個掛載點
sudo mkdir /mnt/data

# 掛載邏輯卷
sudo mount /dev/my_vg/my_lv /mnt/data

# 檢查掛載情況
df -h /mnt/data
```

*   **說明**：這與傳統分割區的操作方式相同。

#### 5. 擴展邏輯卷 (LV)

當 `/mnt/data` 的空間不足時，可以擴展 `my_lv`。

```bash
# 1. 擴展邏輯卷的大小 (例如增加 5GB)
sudo lvextend -L +5G /dev/my_vg/my_lv
# 或者直接擴展到指定大小 (例如總共 15GB)
# sudo lvextend -L 15G /dev/my_vg/my_lv

# 2. 調整檔案系統大小以匹配邏輯卷 (對於 ext2/3/4 檔案系統)
sudo resize2fs /dev/my_vg/my_lv
# 如果是 XFS 檔案系統，使用 xfs_growfs
# sudo xfs_growfs /mnt/data # 注意，XFS 是直接指定掛載點
```

*   **說明**：
    *   `lvextend` 只會調整邏輯卷本身的大小，不會自動調整其上的檔案系統。
    *   `resize2fs` (或 `xfs_growfs`) 才是實際擴展檔案系統的命令。這兩步是必須的。
    *   **注意**：擴展操作通常可以在線進行，不需卸載。

#### 6. 縮小邏輯卷 (LV)

縮小操作比擴展複雜且風險更高，必須非常小心。

```bash
# 假設要將 /dev/my_vg/my_lv 從 15GB 縮小到 8GB

# 1. 卸載檔案系統 (縮小操作必須離線進行)
sudo umount /mnt/data

# 2. 檢查檔案系統的錯誤 (強烈建議)
sudo e2fsck -f /dev/my_vg/my_lv

# 3. 縮小檔案系統 (必須先縮小檔案系統，且必須小於目標邏輯卷大小)
#    我們想縮小到 8GB，所以檔案系統可以縮到 7.5GB 或 7GB
sudo resize2fs /dev/my_vg/my_lv 7G

# 4. 縮小邏輯卷 (必須小於或等於檔案系統的新大小)
sudo lvreduce -L 8G /dev/my_vg/my_lv
# 或者縮小 7GB
# sudo lvreduce -L -7G /dev/my_vg/my_lv

# 5. 重新掛載
sudo mount /dev/my_vg/my_lv /mnt/data

# 6. 檢查
df -h /mnt/data
```

*   **說明**：
    *   **最關鍵的一點**：縮小檔案系統必須在縮小邏輯卷之前完成，並且縮小後的檔案系統大小必須小於或等於目標邏輯卷大小。否則會導致資料丟失。
    *   縮小操作通常需要卸載檔案系統。
    *   `e2fsck` 是在縮小前檢查檔案系統完整性的重要步驟。
    *   `lvreduce` 預設是互動式的，會要求確認。

#### 7. 擴展卷組 (VG)

如果現有的 VG 空間不足，可以添加新的物理卷。

```bash
# 假設有一個新的磁碟 /dev/sdd

# 1. 建立新的物理卷
sudo pvcreate /dev/sdd

# 2. 將新的物理卷添加到現有的卷組 'my_vg'
sudo vgextend my_vg /dev/sdd
```

*   **說明**：`vgextend` 命令會將新的 PV 添加到指定的 VG 中，擴大 VG 的可用空間池，以便可以從中建立更多 LV 或擴展現有的 LV。

#### 8. 刪除 LVM 組件

移除 LVM 組件的順序與建立相反：

```bash
# 1. 卸載邏輯卷 (如果已掛載)
sudo umount /mnt/data

# 2. 刪除邏輯卷
sudo lvremove /dev/my_vg/my_lv

# 3. 刪除卷組 (需要確保卷組中沒有邏輯卷)
sudo vgremove my_vg

# 4. 刪除物理卷 (需要確保物理卷沒有被任何卷組使用)
sudo pvremove /dev/sdb /dev/sdc /dev/sdd
```

*   **說明**：這些命令都是破壞性操作，請務必謹慎執行，並確保在正確的裝置上操作。

-----

### 與相鄰概念的關聯

#### 1. 傳統磁碟分割區 (MBR/GPT)

*   **關聯**：LVM 是建立在傳統磁碟分割區之上的一個抽象層。LVM 的物理卷可以是整個物理硬碟，也可以是硬碟上的一個或多個傳統分割區。傳統分割區（例如 MBR 或 GPT 分割區）提供了磁碟空間的基本劃分，而 LVM 在此基礎上提供了更靈活、動態的儲存管理能力。
*   **區別**：傳統分割區大小固定，難以調整；LVM 則允許彈性調整邏輯卷大小，並且可以聚合多個物理裝置。

#### 2. 檔案系統 (ext4, XFS 等)

*   **關聯**：LVM 負責管理底層的塊裝置（即邏輯卷），而檔案系統則負責在這些塊裝置上組織和存儲資料。兩者是緊密合作的關係：LVM 提供了可動態調整大小的邏輯卷，然後檔案系統在這些邏輯卷上建立。
*   **區別**：LVM 操作的是塊裝置層級，不關心檔案內容。檔案系統則關心檔案、目錄、權限等高階邏輯。當調整邏輯卷大小時，必須獨立地調整其上的檔案系統大小，否則系統仍會認為可用空間沒有改變。

#### 3. RAID (磁碟陣列)

*   **關聯**：LVM 可以與 RAID 結合使用，以提供更高的資料安全性、可用性或性能。
    *   **LVM on RAID**：可以在一個或多個 RAID 陣列之上建立 LVM。例如，先用硬體 RAID 或軟體 RAID (mdadm) 建立一個或多個冗餘的塊裝置，然後將這些 RAID 裝置作為 LVM 的物理卷。這是最常見且推薦的做法，因為 RAID 提供了底層的資料保護，而 LVM 提供了上層的靈活性。
    *   **LVM RAID LV**：LVM 本身也提供類似 RAID 的功能，允許在邏輯卷層級實現 RAID 0 (條帶化)、RAID 1 (鏡像) 等。例如，`lvcreate --type raid1 ...`。這為那些沒有硬體 RAID 或不想使用 `mdadm` 的用戶提供了另一種選擇。
*   **區別**：RAID 主要解決資料冗餘和性能問題，LVM 主要解決儲存空間的彈性管理問題。它們可以在不同的層次上互補。

#### 4. Device Mapper (裝置映射器)

*   **關聯**：Device Mapper 是 Linux 核心中的一個子系統，它為 LVM 提供了底層的技術基礎。LVM 的所有操作（例如將邏輯卷映射到物理卷、實現快照等）都是通過 Device Mapper 來完成的。Device Mapper 允許從一個或多個底層塊裝置建立複雜的虛擬塊裝置。
*   **區別**：Device Mapper 是一個通用的、底層的框架，LVM 是基於這個框架實現的特定儲存管理解決方案。LVM 為使用者提供了更友善的命令列介面和抽象層，而無需直接與 Device Mapper 互動。

-----

### 進階內容：LVM 快照 (Snapshots)

LVM 快照是 LVM 提供的一個強大功能，它允許在一個特定的時間點捕捉邏輯卷的狀態，而無需複製整個邏輯卷的資料。這對於備份、測試軟體升級或系統還原非常有用。

#### 核心觀念

*   **Copy-on-Write (寫時複製)**：快照的工作原理是「寫時複製」。當建立一個快照時，它並不會立即複製原始邏輯卷的所有資料，只是記錄下資料區塊的指針。只有當原始邏輯卷或快照本身有資料被寫入或修改時，被修改的原始資料區塊會被複製到快照空間中，以保留修改前的狀態。
*   **獨立邏輯卷**：快照本身也是一個邏輯卷，可以被掛載、讀取，甚至可以還原。

#### 操作推導

假設我們有一個名為 `/dev/my_vg/my_lv` 的邏輯卷，已掛載到 `/mnt/data`。

1.  **建立快照**
    ```bash
    # 建立一個名為 'my_lv_snap' 的快照，大小為 2GB，針對 'my_lv'
    sudo lvcreate --snapshot -n my_lv_snap -L 2G /dev/my_vg/my_lv
    ```
    *   **說明**：
        *   `--snapshot`：指示建立快照。
        *   `-n my_lv_snap`：指定快照的名稱。
        *   `-L 2G`：指定快照的空間大小。這個大小不是原始資料的完整複製，而是用於儲存原始卷在快照建立後發生的「變化資料」。如果原始卷的變化量超過快照空間，快照會失效。

2.  **掛載快照**
    ```bash
    # 建立快照的掛載點
    sudo mkdir /mnt/snapshot

    # 掛載快照
    sudo mount /dev/my_vg/my_lv_snap /mnt/snapshot

    # 現在可以訪問 /mnt/snapshot 來查看快照建立時的資料狀態
    ```
    *   **說明**：快照邏輯卷是唯讀的（除非在建立時指定可寫）。你可以從快照中複製檔案進行備份。

3.  **還原邏輯卷 (從快照)**
    ```bash
    # 1. 卸載原始邏輯卷 (必須離線還原)
    sudo umount /mnt/data

    # 2. 執行還原操作
    sudo lvconvert --merge /dev/my_vg/my_lv_snap

    # 3. 還原完成後，快照會自動被刪除。重新掛載原始邏輯卷
    sudo mount /dev/my_vg/my_lv /mnt/data
    ```
    *   **說明**：`lvconvert --merge` 會將原始邏輯卷的狀態還原到快照建立時的狀態。這個操作是單向的，且還原後快照會消失。

4.  **刪除快照**
    如果不再需要快照，可以直接刪除它。
    ```bash
    # 卸載快照 (如果已掛載)
    sudo umount /mnt/snapshot

    # 刪除快照邏輯卷
    sudo lvremove /dev/my_vg/my_lv_snap
    ```

-----

### 常見錯誤與澄清

1.  **忘記調整檔案系統大小**
    *   **錯誤**：只執行了 `lvextend` 擴展邏輯卷，但沒有執行 `resize2fs` 或 `xfs_growfs`。
    *   **澄清**：`lvextend` 僅改變 LVM 層次的塊裝置大小，檔案系統層次並不知道其下的儲存空間已擴展。必須執行相應的檔案系統工具來告知檔案系統新的大小。`df -h` 會顯示舊的大小，直到檔案系統被調整。
    *   **例子**：
        ```bash
        sudo lvextend -L +10G /dev/my_vg/my_lv
        # 錯誤：沒有執行下面的命令
        # sudo resize2fs /dev/my_vg/my_lv
        ```

2.  **縮小邏輯卷前未縮小檔案系統或縮小過度**
    *   **錯誤**：在縮小 `lvreduce` 之前未卸載檔案系統或未縮小檔案系統，或者將邏輯卷縮小到比檔案系統還小的尺寸。
    *   **澄清**：**這會導致資料丟失！** 縮小邏輯卷是一個高風險操作。必須先卸載邏輯卷，然後用檔案系統工具（如 `resize2fs`）將檔案系統縮小到目標邏輯卷大小以下，最後再縮小邏輯卷。
    *   **例子**：如果 `my_lv` 為 10GB，且有 8GB 資料。
        *   **正確操作**：
            ```bash
            sudo umount /mnt/data
            sudo e2fsck -f /dev/my_vg/my_lv
            sudo resize2fs /dev/my_vg/my_lv 7G # 檔案系統縮到 7GB
            sudo lvreduce -L 8G /dev/my_vg/my_lv # LV 縮到 8GB (仍大於 7GB)
            sudo mount /dev/my_vg/my_lv /mnt/data
            ```
        *   **錯誤操作 (可能導致資料丟失)**：
            ```bash
            sudo lvreduce -L 5G /dev/my_vg/my_lv # 直接將 LV 縮到 5GB，而檔案系統還是 10GB 甚至有 8GB 資料
            ```

3.  **忘記啟用卷組/邏輯卷**
    *   **錯誤**：在某些情況下（例如從損壞的 LVM 中恢復，或在特定救援環境下），LVM 組件可能未被啟用。
    *   **澄清**：LVM 組件在系統啟動時通常會自動啟用。但如果發現邏輯卷不存在 `/dev/mapper/` 或 `/dev/<VG>/<LV>` 下，可能需要手動掃描和啟用。
    *   **命令**：
        ```bash
        sudo vgscan     # 掃描系統中的所有卷組
        sudo vgchange -a y # 啟用所有活動卷組中的邏輯卷
        sudo lvscan     # 顯示所有邏輯卷的狀態
        ```

4.  **混淆 LVM 顯示命令**
    *   **錯誤**：試圖用 `fdisk -l` 或 `lsblk` 等命令詳細查看 LVM 結構。
    *   **澄清**：`fdisk -l` 等工具只能看到物理分割區。要查看 LVM 的詳細資訊，應使用 LVM 專用命令：
        *   `pvs` 或 `pvdisplay`：查看物理卷資訊。
        *   `vgs` 或 `vgdisplay`：查看卷組資訊。
        *   `lvs` 或 `lvdisplay`：查看邏輯卷資訊。
        *   `lsblk` 是一個例外，它能夠以樹狀結構顯示所有塊裝置，包括 LVM 結構，非常有用。

-----

### 小練習（附詳解）

#### 小練習 1：建立一個基本的 LVM 儲存空間

**情境**：你是一位系統管理員，需要為一個新服務配置一個 8GB 的儲存空間，要求它能夠在未來方便地擴展。目前系統有兩個未使用的虛擬磁碟 `/dev/sdb` 和 `/dev/sdc`。

**目標**：使用 `/dev/sdb` 和 `/dev/sdc` 建立一個 LVM 卷組，並從中劃分一個 8GB 的邏輯卷，格式化為 ext4 檔案系統，然後掛載到 `/srv/data`。

**步驟**：

1.  **準備虛擬磁碟**：假設 `/dev/sdb` 和 `/dev/sdc` 已經存在於你的系統中，並且是空的。
    *   **實際操作提示**：在虛擬機環境中，可以添加兩個新的虛擬磁碟。在實際伺服器上，請確保選擇的是未使用的實體磁碟或分割區。

2.  **建立物理卷 (PV)**
    ```bash
    sudo pvcreate /dev/sdb /dev/sdc
    ```
    *   **檢查**：`sudo pvs`

3.  **建立卷組 (VG)**
    ```bash
    sudo vgcreate service_vg /dev/sdb /dev/sdc
    ```
    *   **檢查**：`sudo vgs`

4.  **建立邏輯卷 (LV)**
    ```bash
    sudo lvcreate -n service_lv -L 8G service_vg
    ```
    *   **檢查**：`sudo lvs`

5.  **格式化邏輯卷**
    ```bash
    sudo mkfs.ext4 /dev/service_vg/service_lv
    ```

6.  **建立掛載點並掛載**
    ```bash
    sudo mkdir /srv/data
    sudo mount /dev/service_vg/service_lv /srv/data
    ```

7.  **驗證**
    ```bash
    df -h /srv/data
    # 預期輸出會顯示 /dev/mapper/service_vg-service_lv 掛載在 /srv/data，容量約 8GB
    ```

8.  **設定開機自動掛載**
    ```bash
    # 編輯 /etc/fstab
    sudo nano /etc/fstab
    # 在文件末尾添加一行：
    # /dev/service_vg/service_lv /srv/data ext4 defaults 0 2
    ```
    *   **驗證**：`sudo mount -a` (檢查 fstab 配置是否正確，無錯誤則表示成功)

#### 小練習 2：擴展 LVM 儲存空間

**情境**：延續練習 1，`service_lv` 的 8GB 空間已經不夠用，現在需要將其擴展到 15GB。系統提供了一個新的虛擬磁碟 `/dev/sdd`。

**目標**：將 `/dev/sdd` 添加到 `service_vg`，然後將 `service_lv` 擴展到 15GB，並調整檔案系統大小。

**步驟**：

1.  **準備新的物理磁碟**：假設 `/dev/sdd` 已經存在且是空的。

2.  **建立新的物理卷 (PV)**
    ```bash
    sudo pvcreate /dev/sdd
    ```
    *   **檢查**：`sudo pvs` (確認 `/dev/sdd` 已成為 PV)

3.  **擴展卷組 (VG)**
    ```bash
    sudo vgextend service_vg /dev/sdd
    ```
    *   **檢查**：`sudo vgs` (確認 `service_vg` 的總大小增加)

4.  **擴展邏輯卷 (LV)**
    ```bash
    # 將 service_lv 擴展到總共 15GB
    sudo lvextend -L 15G /dev/service_vg/service_lv
    # 或者，如果想在現有基礎上增加 7GB：
    # sudo lvextend -L +7G /dev/service_vg/service_lv
    ```
    *   **檢查**：`sudo lvs` (確認 `service_lv` 的大小已變成 15GB)

5.  **調整檔案系統大小**
    ```bash
    sudo resize2fs /dev/service_vg/service_lv
    ```
    *   **檢查**：`df -h /srv/data` (確認 `/srv/data` 的容量已變成 15GB)

-----

### 延伸閱讀與參考

1.  **LVM man pages (使用手冊)**：
    *   `man lvm`：LVM 概覽。
    *   `man pvcreate` / `man pvdisplay` / `man pvs`：物理卷相關命令。
    *   `man vgcreate` / `man vgextend` / `man vgreduce` / `man vgdisplay` / `man vgs`：卷組相關命令。
    *   `man lvcreate` / `man lvextend` / `man lvreduce` / `man lvdisplay` / `man lvs`：邏輯卷相關命令。
    *   `man lvconvert`：用於 LVM 快照、轉換邏輯卷類型等。

2.  **Red Hat Enterprise Linux (RHEL) 官方文件**：
    *   RHEL 提供非常詳細和全面的 LVM 使用指南，是業界標準的參考資料。
    *   通常在「Storage Administration Guide」章節中可以找到。

3.  **Ubuntu Server Guide**：
    *   Ubuntu 的伺服器指南也包含 LVM 的基本使用說明，對於初學者來說是一個很好的起點。

4.  **Arch Linux Wiki**：
    *   Arch Linux Wiki 提供了許多關於 LVM 的實用技巧、進階配置和故障排除資訊。

5.  **LVM Thin Provisioning**：
    *   如果你對儲存空間的彈性有更高要求，可以研究 LVM 的「精簡配置 (Thin Provisioning)」功能，它允許超額分配儲存空間並按需分配。

6.  **LVM RAID Logical Volumes**：
    *   了解 LVM 如何在邏輯卷層次提供 RAID 功能（如鏡像、條帶化），以及它與硬體/軟體 RAID 的異同。