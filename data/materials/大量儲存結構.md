# 大量儲存結構

### 簡介

在現代計算機系統中，除了高速但揮發性高的主記憶體（RAM）之外，我們需要能長久保存資料、容量巨大且成本效益高的儲存設備。這些設備統稱為「大量儲存結構」(Mass Storage Structures)，它們是所有作業系統、應用程式和使用者資料的基石。本章將深入探討各種大量儲存設備的原理、結構、性能特徵以及它們在計算機系統中的重要作用。

-----

### 1. 核心概念與定義

#### 1.1 大量儲存的必要性

主記憶體雖然速度快，但容量有限且斷電後資料會消失（揮發性）。為了應對資料的持久性、巨量化和相對低成本的需求，大量儲存設備應運而生。它們是非揮發性（Non-volatile）的，意味著資料在斷電後仍能保存。

#### 1.2 主要特徵

*   **非揮發性 (Non-volatility)**：資料能持久保存。
*   **容量大 (High Capacity)**：通常以 TB (Terabyte) 或 PB (Petabyte) 為單位。
*   **成本效益 (Cost-effectiveness)**：每位元資料的儲存成本遠低於主記憶體。
*   **速度 (Speed)**：相較於主記憶體較慢，但不同大量儲存設備間速度差異巨大。主要指標包括讀寫延遲 (Latency) 和傳輸頻寬 (Throughput)。
*   **介面 (Interface)**：如 SATA, SAS, NVMe, USB 等，用於連接主機。

#### 1.3 主要類型

1.  **磁碟 (Magnetic Disks)**：
    *   **硬碟機 (Hard Disk Drive, HDD)**：傳統的大量儲存設備，利用磁性介質儲存資料。具備高容量和低成本，但有機械運動部件，速度受限且較易損壞。
    *   **軟碟機 (Floppy Disk Drive)**：已淘汰，作為歷史概念了解即可。
2.  **固態硬碟 (Solid State Drive, SSD)**：
    *   使用快閃記憶體 (NAND Flash Memory) 儲存資料，無機械部件。
    *   具備高速度、低延遲、低功耗、抗震動等優點，但成本相對較高，且有寫入壽命限制。
3.  **磁帶 (Magnetic Tapes)**：
    *   主要用於長期備份、歸檔和異地儲存，讀寫速度較慢（循序存取），但單位容量成本極低。
4.  **光碟 (Optical Disks)**：
    *   如 CD, DVD, Blu-ray Disc。使用雷射讀寫，容量適中，主要用於媒體儲存和分發，不常用於企業級大量資料儲存。
5.  **網路儲存 (Network Storage)**：
    *   **網路附加儲存 (Network-Attached Storage, NAS)**：透過網路提供檔案級儲存服務。
    *   **儲存區域網路 (Storage Area Network, SAN)**：透過專用高速網路提供區塊級儲存服務。

-----

### 2. 典型例子與推導

本節將以最常見的 HDD 和 SSD 為例，深入探討其內部結構和性能計算。

#### 2.1 磁碟機 (HDD)

##### 2.1.1 結構

硬碟機由以下核心部件組成：

*   **磁盤 (Platter)**：一個或多個圓形金屬或玻璃盤片，表面塗有磁性材料，用於儲存資料。
*   **磁頭 (Head)**：負責讀取和寫入資料的裝置，每個磁盤表面對應一個磁頭。
*   **主軸 (Spindle)**：帶動磁盤高速旋轉的馬達。
*   **磁軌 (Track)**：磁盤表面上同心圓形的資料儲存區域。
*   **扇區 (Sector)**：磁軌上最小的資料儲存單位，通常為 512 位元組或 4096 位元組（4K 扇區）。扇區之間通過間隙分隔。
*   **磁柱 (Cylinder)**：所有磁盤上，相同半徑位置的磁軌集合。例如，第 50 號磁柱包含所有磁盤上第 50 號磁軌。
*   **讀寫臂 (Read/Write Arm)**：承載磁頭並能在磁盤表面上方移動，定位到不同磁軌。

邏輯上，磁碟上的資料被組織成一系列的**邏輯區塊位址 (Logical Block Address, LBA)**。作業系統和應用程式只關心 LBA，底層的磁碟控制器負責將 LBA 轉換為物理的 (Cylinder, Head, Sector) 地址。

##### 2.1.2 性能指標與計算

磁碟存取時間是衡量 HDD 性能的關鍵指標，主要由三部分組成：

$$ \text{總存取時間} = \text{搜尋時間 (Seek Time)} + \text{旋轉延遲 (Rotational Latency)} + \text{傳輸時間 (Transfer Time)} $$

1.  **搜尋時間 (Seek Time)**：
    *   磁頭從當前磁軌移動到目標磁軌所需的時間。這是最主要的延遲，通常為數毫秒 (ms)。
    *   平均搜尋時間是廠商提供的典型值。

2.  **旋轉延遲 (Rotational Latency)**：
    *   磁頭到達目標磁軌後，等待目標扇區旋轉到磁頭下方所需的時間。
    *   磁盤轉速越快，旋轉延遲越低。
    *   磁盤轉速通常以每分鐘轉數 (RPM, Rotations Per Minute) 表示。
    *   **平均旋轉延遲**：通常假設為磁盤旋轉半圈所需的時間。
    *   **計算公式**：
        $$ \text{一次旋轉所需時間} = \frac{60 \text{ 秒}}{\text{RPM}} $$
        $$ \text{平均旋轉延遲} = \frac{1}{2} \times \frac{60 \text{ 秒}}{\text{RPM}} $$
        例如，一個 7200 RPM 的硬碟，一次旋轉約需 $ \frac{60}{7200} \approx 0.00833 \text{ 秒} = 8.33 \text{ 毫秒} $。平均旋轉延遲約為 $ 4.16 \text{ 毫秒} $。

3.  **傳輸時間 (Transfer Time)**：
    *   一旦磁頭定位到目標扇區，實際讀取或寫入資料所需的時間。
    *   取決於資料量、磁碟的傳輸頻寬和磁軌上的扇區數量。
    *   **計算公式**：
        $$ \text{傳輸時間} = \frac{\text{要傳輸的位元組數}}{\text{傳輸速率 (Bytes/秒)}} $$
        或
        $$ \text{傳輸時間} = \text{一次旋轉所需時間} \times \frac{\text{要傳輸的扇區數}}{\text{每磁軌扇區數}} $$

##### 範例：HDD 性能計算

假設一個 HDD 具備以下特性：
*   轉速：7200 RPM
*   平均搜尋時間：8 毫秒
*   每磁軌扇區數：500 個 (每個扇區 512 Bytes)
*   目標讀取資料量：10 個扇區

1.  **計算平均旋轉延遲**：
    *   一次旋轉時間 = $ \frac{60 \text{ 秒}}{7200 \text{ RPM}} \approx 0.00833 \text{ 秒} = 8.33 \text{ 毫秒} $
    *   平均旋轉延遲 = $ \frac{1}{2} \times 8.33 \text{ 毫秒} = 4.165 \text{ 毫秒} $

2.  **計算傳輸時間**：
    *   傳輸 10 個扇區。
    *   傳輸時間 = $ 8.33 \text{ 毫秒} \times \frac{10}{500} = 8.33 \text{ 毫秒} \times 0.02 = 0.1666 \text{ 毫秒} $

3.  **計算總存取時間**：
    *   總存取時間 = $ \text{搜尋時間} + \text{平均旋轉延遲} + \text{傳輸時間} $
    *   總存取時間 = $ 8 \text{ 毫秒} + 4.165 \text{ 毫秒} + 0.1666 \text{ 毫秒} \approx 12.33 \text{ 毫秒} $

#### 2.2 固態硬碟 (SSD)

##### 2.2.1 結構與原理

SSD 採用 NAND Flash 記憶體作為儲存介質，主要由 NAND Flash 晶片和控制器 (Controller) 組成。

*   **NAND Flash 晶片**：由許多塊 (Block) 組成，每塊又由許多頁 (Page) 組成。頁是最小的讀寫單位，而塊是最小的擦除單位。
*   **控制器 (Controller)**：SSD 的「大腦」，負責以下關鍵功能：
    *   **LBA 到物理地址的映射 (Flash Translation Layer, FTL)**：將作業系統請求的邏輯區塊位址映射到 NAND Flash 晶片的物理頁面/塊。
    *   **錯誤校正 (Error Correction Code, ECC)**：檢測並修正資料錯誤。
    *   **耗損平均 (Wear Leveling)**：確保 Flash 晶片中所有塊的寫入次數盡可能平均，以延長 SSD 壽命。
    *   **垃圾回收 (Garbage Collection)**：整理已標記為無效的頁面，使其可以重新寫入。
    *   **TRIM 指令處理**：與作業系統協同工作，通知 SSD 哪些資料已被刪除，以便提前擦除對應的 Flash 塊，優化性能和壽命。

##### 2.2.2 性能特徵

由於沒有機械部件，SSD 的性能遠超 HDD：

*   **極低的延遲**：讀寫操作的延遲通常在微秒 (microseconds) 級別，而不是毫秒 (milliseconds) 級別。
*   **高 IOPS (Input/Output Operations Per Second)**：每秒可以處理大量的隨機讀寫操作。
*   **高傳輸頻寬**：循序讀寫速度遠快於 HDD，尤其是 NVMe 介面的 SSD。
*   **抗震性好**：不易受物理震動影響。
*   **無噪音、低功耗**。

##### 2.2.3 寫入壽命與寫入放大 (Write Amplification)

NAND Flash 記憶體的每個塊都有有限的擦除/寫入次數（稱為 P/E cycles）。當達到壽命限制後，該塊可能無法再可靠地儲存資料。SSD 的控制器通過 **耗損平均** 技術來延長壽命。

**寫入放大 (Write Amplification, WA)** 是 SSD 特有的一個現象。當作業系統要求寫入 $X$ 位元組資料時，由於 SSD 內部垃圾回收、耗損平均等機制，SSD 實際寫入到 Flash 晶片的資料量可能會大於 $X$。

$$ \text{寫入放大率 (WA)} = \frac{\text{實際寫入到 Flash 的資料量}}{\text{主機請求寫入的資料量}} $$

WA 越大，SSD 壽命消耗越快，性能也可能受影響。優良的控制器和充足的預留空間 (Over-provisioning) 有助於降低 WA。

-----

### 3. 與相鄰概念的關聯

大量儲存結構並非孤立存在，它們與作業系統、資料庫和網路等眾多領域緊密相連。

#### 3.1 作業系統 (Operating System)

*   **檔案系統 (File System)**：作業系統在大量儲存設備上建立檔案系統，以結構化的方式組織和管理資料（如 ext4, NTFS, APFS）。這包括目錄結構、檔案命名、存取權限、元資料管理等。
*   **磁碟排程 (Disk Scheduling)**：為了優化 HDD 的性能（特別是減少搜尋時間），作業系統會採用磁碟排程演算法來決定 I/O 請求的處理順序。常見的演算法包括：
    *   **FCFS (First-Come, First-Served)**：先來先服務。
    *   **SSTF (Shortest Seek Time First)**：最短搜尋時間優先。
    *   **SCAN (電梯演算法)**：磁頭在磁碟兩端之間移動，服務沿途的請求。
    *   **C-SCAN (循環 SCAN)**：類似 SCAN，但只在一個方向上服務請求，到達一端後直接返回另一端。
*   **虛擬記憶體 (Virtual Memory)**：作業系統將部分磁碟空間用作交換空間 (Swap Space)，在物理記憶體不足時，將不常用的頁面從 RAM 移到磁碟，以擴展可用記憶體容量。
*   **緩衝快取 (Buffer Cache / Disk Cache)**：作業系統在主記憶體中維護一塊區域，用於暫存常用的磁碟資料。當再次需要這些資料時，可以直接從快取讀取，避免耗時的磁碟 I/O 操作，顯著提升性能。

#### 3.2 磁碟陣列 (RAID - Redundant Array of Independent Disks)

RAID 技術將多個物理磁碟組合成一個邏輯單元，以提升性能、提供資料冗餘和容錯能力。

*   **RAID 0 (Stripping)**：將資料分散儲存在多個磁碟上，提升讀寫速度，但沒有冗餘，任意一個磁碟故障都會導致所有資料丟失。
*   **RAID 1 (Mirroring)**：將資料完全複製到至少兩個磁碟上，提供高資料冗餘，但儲存效率低（一半容量用於冗餘）。
*   **RAID 5 (Stripping with Parity)**：將資料和校驗資訊（Parity）分散儲存在多個磁碟上。允許一個磁碟故障，通過校驗資訊重建資料，提供良好的性能和儲存效率。
*   **RAID 6 (Stripping with Dual Parity)**：類似 RAID 5，但儲存兩份校驗資訊，允許兩個磁碟同時故障。
*   **RAID 10 (或 RAID 1+0)**：RAID 1 和 RAID 0 的組合。先將磁碟鏡像 (RAID 1)，然後再將這些鏡像組進行條帶化 (RAID 0)。提供高冗餘和高性能。

#### 3.3 資料庫系統 (Database Systems)

資料庫系統依賴大量儲存結構來永久儲存其巨大的資料集。儲存結構的性能直接影響資料庫的查詢速度、事務處理能力和可靠性。資料庫會特別關注隨機讀寫性能、I/O 頻寬和資料的持久性。

-----

### 4. 進階內容

#### 4.1 SSD 的 TRIM 指令

傳統硬碟刪除檔案時，作業系統只是將檔案的入口標記為「已刪除」，而資料本身仍在磁碟上。當新資料需要寫入時，才會覆蓋舊資料。
對於 SSD 而言，寫入前需要先擦除 (Erase) 整個塊，這是一個耗時的操作。如果 SSD 不知道哪些資料頁是無效的，它可能會在垃圾回收時移動大量無效資料，增加寫入放大和降低性能。

**TRIM 指令** 允許作業系統通知 SSD 哪些邏輯區塊位址已經不再包含有效資料（即已被刪除）。SSD 收到這些資訊後，可以在空閒時提前擦除這些對應的物理頁面或塊，為將來的寫入做好準備，從而：
*   減少寫入放大。
*   維持 SSD 的寫入性能。
*   延長 SSD 壽命。

#### 4.2 NVMe (Non-Volatile Memory Express)

傳統上，SSD 通常使用 SATA 或 SAS 介面連接，這些介面最初是為 HDD 設計的，存在一些性能瓶頸。NVMe 是一種專為基於 PCIe 匯流排的 SSD 設計的高性能介面協定。

**NVMe 的優勢：**
*   **低延遲**：大幅減少了命令傳遞的開銷。
*   **高頻寬**：直接利用 PCIe 匯流排的多通道特性，提供比 SATA 高得多的傳輸速度。
*   **高並行性**：支援更多的 I/O 隊列和更深的隊列深度，能夠處理更多的並行請求，這對於多核心處理器和虛擬化環境尤其重要。

NVMe SSD 已經成為高性能計算、資料中心和高階消費級電腦的首選。

-----

### 5. 常見錯誤與澄清

1.  **HDD 與 SSD 的錯誤比較**
    *   **常見錯誤**：認為 SSD 只是速度更快的 HDD，兩者除了速度外沒有本質區別。
    *   **澄清**：HDD 是機械式設備，受限於物理定律（搜尋、旋轉）。SSD 是固態電子設備，無機械部件，其性能和壽命管理完全依賴控制器和快閃記憶體特性（如寫入壽命、寫入放大）。兩者設計原理和失效模式完全不同。

2.  **混淆磁碟容量與可用空間**
    *   **常見錯誤**：新買的 1TB 硬碟，在電腦上顯示只有約 931GB，認為是產品瑕疵或被騙。
    *   **澄清**：這是由於計算單位不同造成的。硬碟廠商通常使用十進制（1KB = 1000 Bytes, 1GB = $10^9$ Bytes），而作業系統通常使用二進制（1KiB = 1024 Bytes, 1GiB = $2^{30}$ Bytes）。
        $1 \text{ TB (十進制)} = 1,000,000,000,000 \text{ Bytes}$
        $1 \text{ TiB (二進制)} = 2^{40} \text{ Bytes} = 1,099,511,627,776 \text{ Bytes}$
        所以 $1 \text{ TB}$ 大約等於 $1,000,000,000,000 / 1,099,511,627,776 \approx 0.909 \text{ TiB}$，即約 909 GiB。額外的一些空間也可能被韌體、預留空間等佔用。

3.  **磁碟碎片化對 SSD 的影響**
    *   **常見錯誤**：定期對 SSD 進行「磁碟重組」(Defragmentation) 以提升性能。
    *   **澄清**：磁碟重組旨在整理 HDD 上分散的檔案片段，減少磁頭搜尋時間。由於 SSD 無機械部件，資料的物理位置不影響存取時間。對 SSD 進行磁碟重組是沒有意義的，反而會增加不必要的寫入操作，加速寫入壽命的消耗。對於 SSD 應使用 TRIM 功能或讓作業系統自動管理。

4.  **檔案系統與大量儲存設備的關係**
    *   **常見錯誤**：將「硬碟」與「NTFS」或「ext4」劃上等號，認為它們是同一個概念。
    *   **澄清**：硬碟（或 SSD）是物理儲存介質，負責實際儲存位元資料。檔案系統（如 NTFS, ext4, APFS）是作業系統在這些物理介質上建立的「邏輯結構」，負責組織、命名、管理這些資料，讓使用者和應用程式能夠以檔案和目錄的形式存取。沒有檔案系統，硬碟只是一堆原始位元。

-----

### 6. 小練習 (附詳解)

#### 小練習 1：HDD 性能計算

一家公司正在考慮升級其資料庫伺服器的儲存系統。目前使用的是一台 HDD，其規格如下：
*   轉速：15000 RPM
*   平均搜尋時間：3 毫秒
*   磁軌上的扇區數：600 個 (每個扇區 512 Bytes)

現在需要讀取一個包含 20 個扇區的連續資料塊。請計算此操作的總存取時間。

**步驟：**

1.  計算一次旋轉所需的時間。
2.  計算平均旋轉延遲。
3.  計算傳輸這 20 個扇區所需的時間。
4.  將搜尋時間、平均旋轉延遲和傳輸時間相加，得到總存取時間。

**詳解：**

1.  **計算一次旋轉所需的時間：**
    轉速為 15000 RPM。
    一次旋轉時間 = $ \frac{60 \text{ 秒}}{15000 \text{ RPM}} = 0.004 \text{ 秒} = 4 \text{ 毫秒} $

2.  **計算平均旋轉延遲：**
    平均旋轉延遲 = $ \frac{1}{2} \times \text{一次旋轉時間} = \frac{1}{2} \times 4 \text{ 毫秒} = 2 \text{ 毫秒} $

3.  **計算傳輸 20 個扇區所需的時間：**
    每個磁軌有 600 個扇區。
    傳輸時間 = $ \text{一次旋轉時間} \times \frac{\text{要傳輸的扇區數}}{\text{每磁軌扇區數}} $
    傳輸時間 = $ 4 \text{ 毫秒} \times \frac{20}{600} = 4 \text{ 毫秒} \times \frac{1}{30} \approx 0.133 \text{ 毫秒} $

4.  **計算總存取時間：**
    總存取時間 = $ \text{搜尋時間} + \text{平均旋轉延遲} + \text{傳輸時間} $
    總存取時間 = $ 3 \text{ 毫秒} + 2 \text{ 毫秒} + 0.133 \text{ 毫秒} = 5.133 \text{ 毫秒} $

因此，讀取這 20 個扇區的資料約需要 5.133 毫秒。

-----

#### 小練習 2：RAID 應用場景判斷

某公司需要為其儲存系統選擇合適的 RAID 級別。現有以下兩個應用場景：

1.  **場景 A**：需要極高的讀寫性能，尤其是在處理大型文件時，但對資料的容錯能力要求不高，可以接受單點故障導致資料丟失的風險。
2.  **場景 B**：儲存非常重要的商業數據，對資料的可用性和容錯能力有極高要求，可以容忍一個甚至兩個磁碟故障，但性能和儲存成本並非首要考慮因素。

請為每個場景推薦一個最適合的 RAID 級別，並簡要說明原因。

**步驟：**

1.  回顧常見 RAID 級別的特性（性能、容錯、儲存效率）。
2.  根據場景 A 的需求，選擇最匹配的 RAID 級別。
3.  根據場景 B 的需求，選擇最匹配的 RAID 級別。

**詳解：**

1.  **場景 A：極高讀寫性能，容錯能力要求不高。**
    *   **推薦 RAID 級別：RAID 0 (Stripping)**
    *   **原因**：RAID 0 將資料分散儲存在多個磁碟上，實現並行讀寫，理論上讀寫性能是單個磁碟的 N 倍（N 為磁碟數量）。這完美符合「極高的讀寫性能」要求。雖然它不提供任何冗餘，單個磁碟故障將導致所有資料丟失，這符合「容錯能力要求不高，可以接受單點故障」的描述。RAID 0 通常用於臨時工作區、影音編輯等對速度要求極高但資料可輕鬆重建的場景。

2.  **場景 B：極高可用性和容錯能力（容忍一甚至兩個磁碟故障），性能和成本次要。**
    *   **推薦 RAID 級別：RAID 6 (Stripping with Dual Parity)** 或 **RAID 10 (RAID 1+0)**
    *   **原因**：
        *   **RAID 6**：提供雙重校驗位元，允許同時有兩個磁碟故障而不丟失資料，這符合「容忍兩個磁碟故障」的要求，提供了極高的容錯能力。其儲存效率優於 RAID 1/10，且具備較好的讀寫性能。
        *   **RAID 10**：結合了 RAID 1 的鏡像冗餘和 RAID 0 的條帶化性能。它至少需要四個磁碟，提供了極高的容錯能力（可以容忍每個鏡像組中一個磁碟故障），並且有非常出色的讀寫性能。雖然其儲存效率只有 50% (成本較高)，但對於「極高可用性和容錯能力」且不視性能和成本為首要的場景，RAID 10 是一個非常穩健的選擇。
    *   對於「容忍一個甚至兩個磁碟故障」的要求，RAID 5 可以容忍單個磁碟故障。但如果數據極其重要，RAID 6 或 RAID 10 能提供更強的保護，尤其是 RAID 6 明確支持兩個磁碟故障。因此，根據重要性級別，RAID 6 或 RAID 10 是更好的選擇。

-----

### 7. 延伸閱讀/參考

*   **作業系統原理 (Operating System Concepts)**:
    *   Abraham Silberschatz, Peter B. Galvin, Greg Gagne. 《Operating System Concepts》. 詳細介紹了磁碟結構、檔案系統和磁碟排程演算法。
*   **計算機組織與設計 (Computer Organization and Design)**:
    *   David A. Patterson, John L. Hennessy. 《Computer Organization and Design: The Hardware/Software Interface》. 提供從硬體層面理解儲存設備的基礎。
*   **深入理解 Linux 內核 (Understanding the Linux Kernel)**:
    *   Daniel P. Bovet, Marco Cesati. 探討 Linux 系統中磁碟 I/O 和檔案系統的實現細節。
*   **SSD 相關技術文章**：
    *   搜尋 "SSD wear leveling", "SSD garbage collection", "NVMe explained" 等關鍵字，可以找到許多關於固態硬碟技術的深入文章和白皮書。
*   **RAID 相關資源**：
    *   各儲存廠商（如 NetApp, EMC, HPE）的官方網站和技術文檔，通常有詳細的 RAID 介紹和應用建議。