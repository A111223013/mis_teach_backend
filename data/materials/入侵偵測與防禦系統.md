# 3-2 入侵偵測與防禦系統 (IDPS)

本章節將深入探討入侵偵測與防禦系統（IDPS），這是現代網路安全架構中不可或缺的一環。我們將從核心概念出發，理解 IDPS 的運作原理、不同類型及其部署方式，並探討其在防禦網路威脅中的關鍵作用。

-----

### #### 1. 核心概念與定義

入侵偵測與防禦系統 (Intrusion Detection and Prevention Systems, IDPS) 是網路安全領域中的重要工具，旨在監控網路或系統活動，以識別、記錄、警示並在某些情況下主動阻止惡意行為。

#### 1.1 什麼是入侵？

在資訊安全領域，**入侵 (Intrusion)** 指的是任何未經授權的、惡意的、或違反安全策略的活動，這些活動可能導致資訊系統的機密性 (Confidentiality)、完整性 (Integrity) 或可用性 (Availability) 受損。這包括未經授權的存取、資料竊取、服務阻斷攻擊、惡意軟體感染等。

#### 1.2 入侵偵測系統 (IDS)

**入侵偵測系統 (Intrusion Detection System, IDS)** 是一種監控網路或系統活動以偵測潛在惡意行為的軟體或硬體設備。當 IDS 偵測到可疑活動時，它會發出警報，記錄事件，但不主動採取阻斷措施。
*   **核心功能：** 監控、分析、警報、記錄。
*   **主要目標：** 識別攻擊的跡象，提供可供分析的日誌，但不干預流量。

#### 1.3 入侵防禦系統 (IPS)

**入侵防禦系統 (Intrusion Prevention System, IPS)** 結合了 IDS 的偵測功能與主動防禦能力。它不僅能偵測惡意活動，還能根據預設策略即時採取措施來阻斷、隔離或減輕威脅。IPS 通常部署在網路流量路徑上，作為內聯設備 (In-line device)。
*   **核心功能：** 監控、分析、警報、記錄、**主動防禦 (阻斷、重設連線、隔離)**。
*   **主要目標：** 在攻擊發生時，自動採取措施阻止其成功。

#### 1.4 IDPS 的整合

**IDPS** 泛指同時具備入侵偵測和入侵防禦功能的系統。許多現代安全產品都將這兩種功能整合在一起，提供更全面的保護。

-----

### #### 2. 典型例子與部署類型

IDPS 可以根據其偵測方法和部署位置分為不同類型。

#### 2.1 偵測方法分類

IDPS 主要有三種偵測方法：

##### 2.1.1 基於簽章的偵測 (Signature-based Detection)

*   **定義：** 透過比對已知的攻擊模式（稱為「簽章」或「規則」）來識別惡意活動。這些簽章通常由安全專家根據歷史攻擊事件編寫。
*   **例子：**
    *   偵測特定的惡意軟體位元組序列。
    *   比對已知的 SQL Injection 語法模式。
    *   Snort 或 Suricata 等工具使用預定義的規則集來比對網路流量中的特定字串、協議異常或模式。
    *   例如，一個 Snort 規則可能長這樣：`alert tcp any any -> any any (msg:"ET POLICY Dropbox.com Related Domain SSL Cert"; flow:established,to_server; tls.sni; content:"dropbox.com"; http_header; classtype:policy-violation; sid:2018860; rev:6;)`，它會偵測 TLS SNI 欄位中包含 "dropbox.com" 的 HTTP 流量。
*   **優點：** 偵測準確度高，誤報率低。
*   **缺點：** 無法偵測全新的、未知的攻擊 (Zero-day attacks)，需要不斷更新簽章庫。

##### 2.1.2 基於異常的偵測 (Anomaly-based Detection)

*   **定義：** 建立正常網路或系統行為的基準線（Profile），然後監控當前活動，任何顯著偏離此基準線的行為都被視為異常，並可能指示攻擊。
*   **例子：**
    *   某用戶通常在工作時間登入，但突然在凌晨從海外 IP 登入，並下載了大量敏感檔案。
    *   某伺服器的網路流量突然暴增至平時的數十倍，可能指示 DDoS 攻擊。
    *   檔案伺服器上的敏感檔案突然被大量複製或刪除。
*   **優點：** 能夠偵測未知的、新型的攻擊。
*   **缺點：** 可能產生較高的誤報率，因為「正常」行為的範圍難以精確定義，且系統行為會隨時間演進。

##### 2.1.3 基於協議狀態的偵測 (Stateful Protocol Analysis-based Detection)

*   **定義：** 深度理解並監控特定網路協議（如 TCP, HTTP, FTP 等）的狀態和行為。它會根據協議的RFC標準來判斷流量是否合法，並偵測違反協議規範的行為。
*   **例子：**
    *   偵測在 TCP 三向握手完成之前就發送資料的行為（可能暗示埠掃描或惡意封包）。
    *   識別 HTTP 請求中包含非法字符或格式錯誤的報頭。
    *   監控 FTP 會話中違反命令序列的行為。
*   **優點：** 能偵測更複雜的協議層攻擊。
*   **缺點：** 需要對各種協議有深入理解，且對效能有一定要求。

#### 2.2 部署位置分類

根據部署位置，IDPS 可分為網路型和主機型。

##### 2.2.1 網路型 IDPS (NIDS/NIPS)

*   **定義：** 監控整個網路區段的流量，通過分析網路封包來偵測入侵活動。
*   **部署：** 通常部署在網路邊界、防火牆之後、DMZ（非軍事區）或內部關鍵網路段，作為監聽模式 (NIDS) 或內聯模式 (NIPS) 設備。
*   **NIDS (Network Intrusion Detection System)：** 以非侵入性方式監聽網路流量，通常連接到網路交換機的 SPAN/Mirror port。不影響網路性能。
*   **NIPS (Network Intrusion Prevention System)：** 部署在網路流量路徑中，作為防火牆的下一跳或替代品，能夠即時分析並阻斷惡意流量。會對網路性能產生影響。
*   **優點：** 廣泛覆蓋，可監控多台主機，不佔用被監控主機的資源。
*   **缺點：** 無法看到加密流量的內部內容；可能在高速網路環境下產生效能瓶頸導致丟包；難以偵測單一主機內部的行為。

##### 2.2.2 主機型 IDPS (HIDS/HIPS)

*   **定義：** 安裝在單一主機（伺服器、工作站）上的代理程式，監控該主機的系統日誌、檔案完整性、進程活動、登錄檔變更等。
*   **部署：** 安裝在需要保護的特定主機上。
*   **HIDS (Host Intrusion Detection System)：** 監控主機活動，發送警報。
*   **HIPS (Host Intrusion Prevention System)：** 監控並主動阻止惡意進程運行、修改關鍵檔案或未經授權的系統操作。
*   **優點：** 能深入監控主機內部活動，包括加密流量解密後的行為；能偵測針對特定應用程式的攻擊。
*   **缺點：** 佔用主機資源；管理複雜，需在每台主機上安裝維護；無法看到網路層面的廣泛攻擊。

-----

### #### 3. 與相鄰概念的關聯

IDPS 並不是獨立的安全工具，它與其他安全措施緊密合作，共同構建多層次的安全防禦體系。

#### 3.1 與防火牆 (Firewall) 的關聯

*   **防火牆：** 主要功能是基於預設規則（如 IP 位址、埠號、協議）來過濾網路流量。它在網路邊界作為第一道防線，決定哪些流量可以進入或離開網路。防火牆關注的是「誰可以進出」。
*   **IDPS：** 關注的是「進來的流量在做什麼」。即使是防火牆允許的合法流量，IDPS 也能進一步分析其內容和行為，偵測其中的惡意意圖。
*   **關係：** 防火牆是粗粒度的過濾器，IDPS 是細粒度的分析器。兩者協同工作，防火牆擋掉顯然惡意的或不符合策略的流量，IDPS 則深入檢查通過防火牆的流量中潛在的威脅。例如，防火牆可能允許所有 80 埠的流量進入，但 NIPS 會檢查這些 HTTP 流量中是否包含 SQL Injection 攻擊。

#### 3.2 與防毒軟體 (Antivirus) 的關聯

*   **防毒軟體：** 主要針對已知惡意軟體（病毒、木馬、蠕蟲、勒索軟體）進行偵測、隔離和清除，通常部署在端點（個人電腦、伺服器）。它主要關注惡意檔案。
*   **IDPS：** 範圍更廣，不僅限於惡意軟體。它還能偵測網路掃描、DDoS 攻擊、策略違規、未經授權的系統存取等行為。HIPS 有時會包含防毒功能，但其核心功能是行為監控。
*   **關係：** 防毒軟體主要在端點層面對抗已知的惡意檔案威脅，而 IDPS 則在網路層和系統層對抗更廣泛的入侵行為，包括那些不涉及惡意檔案的攻擊。

#### 3.3 與安全資訊與事件管理 (SIEM) 的關聯

*   **IDPS：** 產生大量的安全事件警報和日誌。
*   **SIEM (Security Information and Event Management)：** 是一個中央化的平台，負責收集、儲存、聚合、關聯和分析來自各種安全設備（包括防火牆、IDPS、伺服器、應用程式等）的日誌和事件資料。
*   **關係：** IDPS 是 SIEM 的重要資訊來源之一。SIEM 利用 IDPS 提供的警報，結合其他日誌，進行更深層次的關聯分析，以識別更複雜的複合式攻擊，提供統一的安全態勢視圖，並協助事件回應。

-----

### #### 4. 進階內容：IDPS 的挑戰與趨勢

IDPS 在提供安全防護的同時，也面臨著一些挑戰，並且技術仍在不斷演進。

#### 4.1 誤報 (False Positive) 與漏報 (False Negative)

這是 IDPS 面臨的核心挑戰：

*   **誤報 (False Positive)：** 將合法活動錯誤地識別為惡意活動。例如，正常的系統維護操作被誤判為入侵嘗試。
    *   **影響：** 造成警報疲勞，浪費分析資源，NIPS 可能會阻斷合法流量，影響業務可用性。
*   **漏報 (False Negative)：** 惡意活動未能被偵測到。例如，新型攻擊繞過了 IDPS 的偵測。
    *   **影響：** 攻擊成功，導致資料洩露、服務中斷等嚴重後果。
*   **優化：** 需要不斷調整 IDPS 的規則、行為基準，並結合多種偵測方法、威脅情資以及人工審核來降低誤報和漏報。

#### 4.2 入侵防禦系統 (IPS) 的挑戰

由於 IPS 部署在內聯模式，它對網路性能和可用性有直接影響：

*   **延遲 (Latency)：** 數據包需要經過 IPS 的深度分析，這可能會引入額外的處理延遲，對於對延遲敏感的應用（如視訊會議、金融交易）可能造成問題。
*   **阻斷誤報：** 若 IPS 錯誤地阻斷了合法流量，將直接導致業務中斷。這要求 IPS 具有極高的判斷準確性。
*   **效能瓶頸：** 在高流量環境下，IPS 可能成為網路的效能瓶頸，無法處理所有流量，導致丟包或繞過安全檢查。
*   **加密流量：** 隨著 SSL/TLS 廣泛使用，加密流量使 IPS 難以檢查其內部內容。解決方案包括 SSL/TLS 解密檢查，但也帶來效能開銷和隱私問題。

#### 4.3 機器學習與人工智慧 (AI/ML) 在 IDPS 中的應用

為了應對傳統 IDPS 的挑戰，AI/ML 技術正被廣泛應用：

*   **強化異常偵測：** 機器學習模型可以學習更複雜的正常行為模式，提高異常偵測的準確性和適應性，降低誤報率。
*   **零日攻擊偵測：** 通過分析流量或系統活動中的細微異常，ML 模型有潛力在沒有已知簽章的情況下識別新型威脅。
*   **威脅情資自動化：** AI 可以自動分析海量的威脅情資，識別新興威脅，並自動更新偵測規則。
*   **自適應安全：** 結合 AI，IDPS 可以根據實時威脅情資和環境變化，動態調整其防禦策略。

-----

### #### 5. 常見錯誤與澄清

在使用和部署 IDPS 時，一些常見的誤解和錯誤觀念需要澄清。

#### 5.1 IDPS 萬能論

*   **錯誤觀念：** 認為只要部署了 IDPS，就能解決所有安全問題。
*   **澄清：** IDPS 是一種強大的安全工具，但它不是銀彈。它必須與防火牆、防毒軟體、安全意識培訓、定期的漏洞掃描和修補、以及完善的事件回應計畫等其他安全措施結合使用，才能構建一個全面的、多層次的安全防禦體系。

#### 5.2 IDS 等同於 IPS

*   **錯誤觀念：** 將入侵偵測系統 (IDS) 和入侵防禦系統 (IPS) 的功能混為一談。
*   **澄清：** IDS 只能**偵測**並發出警報，它不具備主動**防禦**和阻斷的能力。IPS 則部署在內聯模式，能夠即時分析流量並主動採取措施阻止攻擊。兩者在功能上有本質區別，儘管許多產品將兩者整合。

#### 5.3 只部署一種 IDPS 類型

*   **錯誤觀念：** 認為只要部署了網路型 IDPS (NIDS/NIPS) 或主機型 IDPS (HIDS/HIPS) 之一就足夠了。
*   **澄清：** NIDS/NIPS 和 HIDS/HIPS 各有優勢和劣勢。NIDS/NIPS 提供廣泛的網路層保護，但可能無法深入應用程式層和加密流量；HIDS/HIPS 提供精細的主機層保護，但無法監控整個網路。最佳實踐是**結合使用**這兩種部署方式，形成更全面的防禦。例如，NIDS 監控網路邊界，HIDS 監控關鍵伺服器。

#### 5.4 忽略 IDPS 產生的日誌和警報

*   **錯誤觀念：** 部署 IDPS 後，只需讓它自動運行，無需人工干預或分析其產生的日誌。
*   **澄清：** IDPS 會產生大量的日誌和警報。這些資訊是了解當前威脅態勢、識別攻擊趨勢、優化安全策略的寶貴資產。**必須**有專門的人員或 SIEM 系統對這些日誌進行定期審查和分析，以區分真假警報，並根據分析結果調整 IDPS 策略。忽視日誌分析會讓 IDPS 變成一個「擺設」。

-----

### #### 6. 小練習（附詳解）

#### 小練習 1：入侵偵測方法判斷

某公司部署了一套 IDPS，在不同情境下偵測到了以下事件。請判斷這些事件最可能由哪種入侵偵測方法（基於簽章、基於異常、基於協議狀態）識別出來，並簡要說明理由。

1.  **情境 A：** 偵測到從外部 IP 傳入的 TCP 流量中包含與已知惡意軟體 `BadTrojan.exe` 的特定位元組序列完全匹配的內容。
2.  **情境 B：** 偵測到公司財務部一名員工的帳戶在非工作時間（凌晨 2 點）從一個從未出現過的 IP 位址登入，並嘗試在短時間內從資料庫中導出大量客戶資料。
3.  **情境 C：** 偵測到一個針對公司網站的 HTTP 請求，其中包含一個長度遠超正常範圍的 URL 參數，且該參數中的字符序列與多個已知的緩衝區溢位攻擊模式相似。
4.  **情境 D：** 偵測到一個惡意行為，該行為涉及在建立 TCP 連線的三向握手完成之前，就立即發送了大量的 UDP 封包到目標主機。

---

##### 詳解 1：

1.  **情境 A：**
    *   **偵測方法：** **基於簽章的偵測 (Signature-based Detection)**
    *   **理由：** 偵測到與已知惡意軟體 `BadTrojan.exe` 的「特定位元組序列完全匹配」的內容，這正是基於簽章偵測的核心原理，即比對預定義的已知攻擊模式。

2.  **情境 B：**
    *   **偵測方法：** **基於異常的偵測 (Anomaly-based Detection)**
    *   **理由：** 該事件涉及「非工作時間」、「從未出現過的 IP 位址」登入，並「嘗試導出大量客戶資料」，這些都明顯偏離了該員工帳戶的「正常行為模式」。基於異常的偵測是通過建立正常行為基準線來識別這種偏離。

3.  **情境 C：**
    *   **偵測方法：** **基於簽章的偵測** 或 **基於協議狀態的偵測** （此處偏向簽章，但若同時涉及協議解析則為協議狀態）
    *   **理由：** 「長度遠超正常範圍的 URL 參數」可能由**基於異常**的偵測發現，但「參數中的字符序列與多個已知的緩衝區溢位攻擊模式相似」則明確指向**基於簽章**的偵測。若 IDPS 需深度解析 HTTP 協議結構來判斷參數合法性，則也包含**基於協議狀態**的偵測。在此情況下，簽章偵測是主要判斷依據。

4.  **情境 D：**
    *   **偵測方法：** **基於協議狀態的偵測 (Stateful Protocol Analysis-based Detection)**
    *   **理由：** 「在建立 TCP 連線的三向握手完成之前，就立即發送了大量的 UDP 封包」這行為明顯違反了 TCP 和 UDP 協議的正常狀態和交互規範。基於協議狀態的偵測能夠理解並監控協議的正確序列和行為，從而識別這類異常。

#### 小練習 2：IDPS 部署策略

一家中型網路服務公司，業務包括一個面向公眾的電商網站 (部署在 DMZ)，一個內部管理系統 (內部網路)，以及大量員工工作站。請你作為資安顧問，為該公司規劃一套合理的 IDPS 部署策略，說明在哪些位置部署哪種 IDPS 類型（NIDS/NIPS 或 HIDS/HIPS），並簡要說明原因。

---

##### 詳解 2：

針對該中型網路服務公司的業務場景，建議採用分層防禦策略，結合 NIDS/NIPS 和 HIDS/HIPS 的優勢。

1.  **網路型 IDPS (NIDS/NIPS) 的部署：**
    *   **部署位置 1：** **在公司網路邊界（防火牆之後、網際網路之前）**
        *   **類型：** **NIPS (Network Intrusion Prevention System)**
        *   **原因：** 作為第一道深度防禦，NIPS 可以即時監控所有進出公司的流量，主動阻擋惡意封包（如 DDoS 攻擊、已知蠕蟲流量、惡意掃描）進入公司網路，減輕內部系統的負擔。
    *   **部署位置 2：** **在 DMZ 區域與內部網路之間**
        *   **類型：** **NIPS (Network Intrusion Prevention System)**
        *   **原因：** 電商網站部署在 DMZ，對外開放，是高風險區域。部署 NIPS 可以監控從 DMZ 進入內部網路的流量，防止網站被攻陷後作為跳板進一步攻擊內部系統。同時，也能監控對 DMZ 內部伺服器（如 Web Server、Application Server）的攻擊。
    *   **部署位置 3：** **在內部網路的核心交換機旁（或關鍵子網間）**
        *   **類型：** **NIDS (Network Intrusion Detection System)**
        *   **原因：** NIDS 以監聽模式部署，用於監控內部網路的橫向移動 (Lateral Movement) 和內部威脅。即使外部防禦被突破，也能偵測到攻擊者在內部網路的活動，例如內部主機掃描、敏感資料異常傳輸、或內部員工的惡意行為。選擇 NIDS 避免對內部網路性能造成影響。

2.  **主機型 IDPS (HIDS/HIPS) 的部署：**
    *   **部署位置 1：** **在所有電商網站的伺服器 (Web Server, Application Server, Database Server) 上**
        *   **類型：** **HIPS (Host Intrusion Prevention System)**
        *   **原因：** 這些伺服器是公司的核心資產，面臨高風險。HIPS 可以監控作業系統日誌、應用程式日誌、檔案完整性、進程行為。即使攻擊成功繞過 NIPS 抵達伺服器，HIPS 也能偵測並阻止惡意行為（如提權、惡意指令執行、敏感檔案篡改或竊取），提供應用層級的精細保護。
    *   **部署位置 2：** **在內部管理系統的伺服器上**
        *   **類型：** **HIPS (Host Intrusion Prevention System)**
        *   **原因：** 內部管理系統通常包含敏感的業務資料。HIPS 可以提供深度監控，防止內部員工的未經授權操作或外部攻擊者成功進入內部網路後對這些系統進行破壞。
    *   **部署位置 3：** **在所有員工工作站上**
        *   **類型：** **HIPS (Host Intrusion Prevention System)**
        *   **原因：** 員工工作站是惡意軟體和網路釣魚的主要入口。HIPS 可以監控惡意軟體活動、不安全的應用程式執行、未經授權的USB設備使用、以及防止惡意指令碼的運行，作為端點保護的重要組成部分。

**總結：**
這套策略結合了網路層面的廣泛防禦和主機層面的深度防護。NIPS 在網路邊界和關鍵網路段負責第一時間阻擋大部分已知威脅；NIDS 監控內部橫向移動；而 HIPS 則在最關鍵的伺服器和員工工作站提供最後一道、最精細的保護，確保即使網路層防禦被突破，核心資產也能得到有效保護。

-----

### #### 7. 延伸閱讀/參考

*   **NIST Special Publication 800-94 (Guide to Intrusion Detection and Prevention Systems (IDPS))**: 美國國家標準與技術研究院發布的 IDPS 指南，包含詳細的定義、部署和管理建議。
    *   [https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-94.pdf](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-94.pdf)
*   **Snort 官方文件**: 一款開源的網路入侵偵測/防禦系統 (NIDS/NIPS)，廣泛用於學習和部署。
    *   [https://www.snort.org/](https://www.snort.org/)
*   **Suricata 官方文件**: 另一款開源、高性能的網路入侵偵測/防禦系統 (NIDS/NIPS) 和安全監控引擎。
    *   [https://suricata.io/](https://suricata.io/)
*   **OWASP Top 10**: 開放網路應用程式安全專案，列出了 Web 應用程式最關鍵的十大安全風險，IDPS 在防禦這些風險中扮演重要角色。
    *   [https://owasp.org/www-project-top-ten/](https://owasp.org/www-project-top-ten/)