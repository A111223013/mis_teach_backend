## 2-3 主鍵與外部鍵

在關聯式資料庫中，資料表之間的關聯以及資料的唯一性與完整性是設計的基石。主鍵 (Primary Key) 和外部鍵 (Foreign Key) 是實現這些目標的核心機制，它們確保了資料的準確性、一致性與可關聯性。

-----

### 核心概念：資料關聯與識別

想像一個圖書館系統，我們有會員、書籍和借閱記錄。要如何確保每一位會員、每一本書都有唯一的身份？又如何追蹤哪位會員借了哪本書？主鍵與外部鍵正是解決這些問題的關鍵。

主鍵用來唯一識別資料表中的每一筆記錄，就像每個人的身分證號碼。外部鍵則是用來連結不同資料表，建立它們之間的關聯，確保一個資料表的記錄能正確地參照到另一個資料表的記錄。

-----

### 主鍵 (Primary Key)

#### 1. 定義與核心觀念

**定義：** 主鍵是一個或多個欄位的組合，其值能唯一地識別資料表中每一筆記錄。

**核心觀念：**
*   **唯一性 (Uniqueness)：** 表中的任何兩筆記錄不能有相同的主鍵值。
*   **非空性 (Non-nullability)：** 主鍵欄位的值不能為空 (NULL)。

主鍵是資料表的「身分證」，它保證了每一筆資料的獨一無二，是資料表中最關鍵的識別符。

#### 2. 特性與規則

*   **唯一：** 每個主鍵值在資料表中必須是唯一的。
*   **非空：** 主鍵欄位不能包含 NULL 值。
*   **單一：** 每個資料表只能有一個主鍵。這個主鍵可以由一個欄位組成，也可以由多個欄位（稱為複合主鍵）組成。
*   **穩定：** 一旦指定，主鍵的值應盡量保持不變，因為更改主鍵值可能會影響到參照該主鍵的外部鍵。

#### 3. 典型例子與 SQL 語法

考慮一個 `Students` (學生) 資料表：

```sql
CREATE TABLE Students (
    student_id INT PRIMARY KEY, -- student_id 是主鍵
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    enrollment_date DATE
);
```

在這個例子中，`student_id` 被定義為主鍵。這表示：
1.  每個學生的 `student_id` 都必須是唯一的。
2.  `student_id` 不能為 NULL。

**複合主鍵範例：**
當單一欄位不足以唯一識別一筆記錄時，可以使用多個欄位組成複合主鍵。
例如，在一個表示訂單細節的 `Order_Details` (訂單明細) 資料表中：

```sql
CREATE TABLE Order_Details (
    order_id INT,
    product_id INT,
    quantity INT NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    PRIMARY KEY (order_id, product_id) -- order_id 和 product_id 組成複合主鍵
);
```
此處，`order_id` 和 `product_id` 的組合才能唯一識別一條訂單中的某個產品。

#### 4. 與相鄰概念的關聯：`UNIQUE` 與 `NOT NULL`

*   **`UNIQUE` 約束：** 確保欄位中的所有值都是唯一的。與主鍵不同的是，`UNIQUE` 約束的欄位**可以**包含 NULL 值（通常允許多個 NULL 值，因為 NULL 不被認為是與任何值相等）。一個資料表可以有多個 `UNIQUE` 約束。
*   **`NOT NULL` 約束：** 確保欄位中的值不能為 NULL。它不保證值的唯一性。
*   **主鍵 (`PRIMARY KEY`)** 實際上是 `UNIQUE` 和 `NOT NULL` 約束的組合，並且每個資料表只能有一個。當您將一個欄位設定為主鍵時，它會自動具備這兩個特性。

```sql
-- 比較 UNIQUE 和 PRIMARY KEY
CREATE TABLE Users (
    user_id INT PRIMARY KEY,           -- 唯一且非空
    username VARCHAR(50) UNIQUE NOT NULL, -- 唯一且非空
    email VARCHAR(100) UNIQUE,         -- 唯一，但可以為空 (NULL)
    phone_number VARCHAR(20)
);
```
`username` 雖然也是唯一且非空，但它不是主鍵。通常，主鍵會被選作資料表的主要識別符，並作為其他資料表參照的目標。

-----

### 外部鍵 (Foreign Key)

#### 1. 定義與核心觀念

**定義：** 外部鍵是一個或多個欄位，它參照（指向）另一個資料表（或同一個資料表）的主鍵（或唯一鍵）。外部鍵用於在兩個資料表之間建立連結。

**核心觀念：**
*   **參照完整性 (Referential Integrity)：** 確保外部鍵的值必須在被參照的主鍵欄位中存在，或者為 NULL (如果允許)。它防止了「孤兒記錄」的產生，即指向不存在記錄的連結。

外部鍵是建立資料表之間關聯的「橋樑」，它確保了資料的一致性和有效性。

#### 2. 目的與參照完整性

*   **目的：**
    *   **連結資料表：** 建立不同資料表之間的關聯，實現資料庫正規化，減少資料冗餘。
    *   **維護資料一致性：** 確保當一個資料表的記錄被更新或刪除時，另一個資料表中相關聯的記錄也能被正確處理。
*   **參照完整性：** 這是外部鍵最核心的功能。它保證了如果一個外部鍵有值，那麼這個值必須在它所參照的主鍵欄位中存在。例如，你不能訂購一個不存在的產品。

#### 3. 典型例子與 SQL 語法

考慮 `Customers` (客戶) 和 `Orders` (訂單) 兩個資料表。每個訂單都應屬於某個客戶。

```sql
CREATE TABLE Customers (
    customer_id INT PRIMARY KEY,
    customer_name VARCHAR(100) NOT NULL
);

CREATE TABLE Orders (
    order_id INT PRIMARY KEY,
    customer_id INT, -- 此處的 customer_id 是外部鍵
    order_date DATE NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (customer_id) REFERENCES Customers(customer_id)
    -- 這行定義了外部鍵：Orders.customer_id 參照 Customers.customer_id
);
```

在這個例子中：
*   `Orders` 表的 `customer_id` 是一個外部鍵。
*   它參照 `Customers` 表的 `customer_id` (主鍵)。
*   這意味著 `Orders.customer_id` 的值必須在 `Customers.customer_id` 中存在，或者為 NULL。

**自參照外部鍵範例：**
外部鍵也可以參照同一個資料表中的主鍵，這稱為自參照外部鍵。例如，在一個 `Employees` (員工) 資料表中，每個員工可能有一個上司 (經理)，而這個經理本身也是員工。

```sql
CREATE TABLE Employees (
    employee_id INT PRIMARY KEY,
    employee_name VARCHAR(100) NOT NULL,
    manager_id INT, -- 參照同表的 employee_id
    FOREIGN KEY (manager_id) REFERENCES Employees(employee_id)
);
```

#### 4. 參照動作 (Referential Actions)

當主鍵表中的記錄被刪除或更新時，外部鍵表中的相關記錄如何處理？這由 `ON DELETE` 和 `ON UPDATE` 動作來指定。

*   **`ON DELETE` 動作：** 當主鍵表中的記錄被刪除時，外部鍵表中的相關記錄如何處理。
    *   **`NO ACTION` / `RESTRICT` (限制)：** 預設行為。如果外部鍵表中有任何參照該主鍵的記錄，則不允許刪除主鍵表中的記錄。會拋出錯誤。
    *   **`CASCADE` (級聯)：** 當主鍵表中的記錄被刪除時，外部鍵表中所有參照該記錄的行也將被刪除。
    *   **`SET NULL` (設定為 NULL)：** 當主鍵表中的記錄被刪除時，外部鍵表中參照該記錄的欄位將被設為 NULL。這要求外部鍵欄位必須允許 NULL 值。
    *   **`SET DEFAULT` (設定為預設值)：** 當主鍵表中的記錄被刪除時，外部鍵表中參照該記錄的欄位將被設為其預設值。這要求外部鍵欄位有預設值。

*   **`ON UPDATE` 動作：** 當主鍵表中的主鍵值被更新時，外部鍵表中的相關記錄如何處理。
    *   動作選項與 `ON DELETE` 類似：`NO ACTION`, `RESTRICT`, `CASCADE`, `SET NULL`, `SET DEFAULT`。

**範例：**

```sql
CREATE TABLE Orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    order_date DATE NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (customer_id) REFERENCES Customers(customer_id)
        ON DELETE CASCADE    -- 當客戶被刪除時，其所有訂單也將被刪除
        ON UPDATE CASCADE    -- 當客戶ID被更新時，其所有訂單的customer_id也將更新
);

CREATE TABLE Payments (
    payment_id INT PRIMARY KEY,
    order_id INT,
    payment_date DATE,
    amount DECIMAL(10, 2),
    FOREIGN KEY (order_id) REFERENCES Orders(order_id)
        ON DELETE SET NULL   -- 當訂單被刪除時，付款記錄的 order_id 設為 NULL
                             -- (假設 payment_id 允許 NULL)
        ON UPDATE CASCADE
);
```

#### 5. 與相鄰概念的關聯：主鍵

*   **外部鍵的「參考」對象通常是另一個資料表的主鍵。** 主鍵提供了唯一且非空的目標，確保外部鍵參照的有效性。
*   外部鍵是建立關聯的橋樑，而主鍵是關聯的目標。沒有主鍵，外部鍵就無法有效地建立資料表之間的連結。
*   儘管在某些資料庫系統中，外部鍵也可以參照具有 `UNIQUE` 約束而非主鍵的欄位，但最佳實踐和最常見的情況是參照主鍵。

-----

### 主鍵與外部鍵的關係：資料庫設計的基石

主鍵和外部鍵共同構成了關聯式資料庫設計的基礎。
*   **主鍵** 賦予資料表中每條記錄獨特的身份。
*   **外部鍵** 則利用這些身份，建立不同資料表之間的邏輯關聯。

它們一起確保了資料的：
1.  **唯一性：** 每筆資料都有其獨特識別。
2.  **完整性：** 資料之間的關聯總是有效且一致。
3.  **關聯性：** 能夠輕鬆地在不同資料表之間查詢和組合資料。

這對於資料庫的正規化、查詢效率和長期維護都至關重要。

-----

### 常見錯誤與澄清

*   **錯誤 1：主鍵欄位允許 NULL 值。**
    *   **澄清：** 主鍵嚴格要求非空 (`NOT NULL`)。如果一個欄位允許 NULL，它就不能作為主鍵。
*   **錯誤 2：外部鍵欄位必須是主鍵欄位。**
    *   **澄清：** 外部鍵欄位本身不必是它所屬資料表的主鍵。例如，`Orders.customer_id` 是一個外部鍵，但 `order_id` 才是 `Orders` 表的主鍵。外部鍵只是參照另一個表的主鍵。
*   **錯誤 3：在刪除主鍵表記錄時，未考慮 `ON DELETE` 動作。**
    *   **澄清：** 預設情況下，許多資料庫會使用 `RESTRICT` 或 `NO ACTION`，這意味著如果外部鍵表中有相關記錄，您將無法刪除主鍵表中的記錄。設計資料庫時，務必根據業務邏輯選擇合適的 `ON DELETE`（和 `ON UPDATE`）動作，例如 `CASCADE` 或 `SET NULL`。
*   **錯誤 4：認為複合主鍵不常用。**
    *   **澄清：** 複合主鍵在處理多對多關聯的中介表（或稱連接表）中非常常見。例如，`Order_Details` 表中的 (`order_id`, `product_id`) 複合主鍵，就是為了唯一標識某個訂單中的某個產品。

-----

### 小練習

**情境：** 您正在設計一個小型圖書館借閱系統。

**資料表：**
1.  `Books` (圖書)：包含圖書的資訊。
2.  `Members` (會員)：包含會員的資訊。
3.  `Loans` (借閱記錄)：記錄哪位會員何時借閱了哪本書。

**要求：**
1.  為 `Books` 和 `Members` 表選擇合適的主鍵。
2.  建立 `Loans` 表，使其能連結 `Books` 和 `Members` 表，並定義外部鍵。
3.  考慮當一本書被從系統中永久移除時（即 `Books` 表中某本書被刪除），其所有相關借閱記錄 (在 `Loans` 表中) 應如何處理，並在 SQL 語句中體現。

#### 詳解

**步驟 1：定義 `Books` 和 `Members` 表及主鍵。**
我們為書籍選擇 `book_id` 作為主鍵，為會員選擇 `member_id` 作為主鍵。

```sql
-- 1. 建立 Books 資料表
CREATE TABLE Books (
    book_id INT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    author VARCHAR(100),
    isbn VARCHAR(13) UNIQUE NOT NULL
);

-- 2. 建立 Members 資料表
CREATE TABLE Members (
    member_id INT PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL
);
```

**步驟 2：建立 `Loans` 表，包含外部鍵。**
`Loans` 表需要連結到 `Books` 和 `Members`。`book_id` 和 `member_id` 將成為 `Loans` 表中的外部鍵。`loan_id` 可以作為 `Loans` 表自身的主鍵，或者 (`book_id`, `member_id`, `loan_date`) 的組合。這裡我們使用 `loan_id` 作為主鍵，簡化唯一性管理。

```sql
-- 3. 建立 Loans 資料表，並定義外部鍵
CREATE TABLE Loans (
    loan_id INT PRIMARY KEY AUTO_INCREMENT, -- 使用自動遞增的 loan_id 作為主鍵
    book_id INT NOT NULL,
    member_id INT NOT NULL,
    loan_date DATE NOT NULL,
    return_date DATE, -- 歸還日期可能為空，表示尚未歸還

    -- 定義外部鍵：book_id 參照 Books 表的 book_id
    FOREIGN KEY (book_id) REFERENCES Books(book_id)
        ON DELETE CASCADE, -- 當 Books 表中的書被刪除時，所有相關的借閱記錄也一併刪除

    -- 定義外部鍵：member_id 參照 Members 表的 member_id
    FOREIGN KEY (member_id) REFERENCES Members(member_id)
        ON DELETE RESTRICT -- 當 Members 表中的會員被刪除時，如果他還有借閱記錄，則禁止刪除
);
```

**步驟 3：處理書籍刪除時的借閱記錄。**
根據要求「當一本書被從系統中永久移除時，其所有相關借閱記錄應如何處理」，我們在 `Loans` 表的 `book_id` 外部鍵上設定了 `ON DELETE CASCADE`。
*   `ON DELETE CASCADE` 的效果：如果 `Books` 表中 ID 為 `X` 的書被刪除，那麼 `Loans` 表中所有 `book_id` 為 `X` 的記錄也會自動被刪除。這確保了不會有記錄指向不存在的書籍。
*   對於 `Members` 表，我們選擇了 `ON DELETE RESTRICT`。這意味著如果一個會員還有未處理的借閱記錄，您將無法從 `Members` 表中刪除該會員，直到所有相關借閱記錄被清除或處理。這是一種更嚴格的參照完整性控制，防止意外刪除重要記錄。

這個設計確保了資料庫的完整性，並在資料被刪除時提供了明確的處理邏輯。

-----

### 延伸閱讀

*   **資料庫正規化 (Database Normalization)：** 了解主鍵和外部鍵如何支持將資料庫設計成第一範式 (1NF)、第二範式 (2NF)、第三範式 (3NF) 等，以減少資料冗餘並提高資料完整性。
*   **資料完整性 (Data Integrity)：** 深入了解不同類型的資料完整性（實體完整性、參照完整性、域完整性、使用者定義完整性）以及主鍵和外部鍵在實現這些完整性中的作用。
*   **索引 (Indexes)：** 主鍵通常會自動創建索引，外部鍵也經常建議建立索引。了解索引如何提高查詢效能，以及它們與主鍵和外部鍵的關係。
*   **ACID 特性：** 了解關聯式資料庫的 ACID (原子性、一致性、隔離性、持久性) 特性，以及主鍵和外部鍵如何幫助維護資料的一致性 (Consistency)。