# 3-1 防火牆與使用政策

## ### 1. 核心概念與定義

#### #### 1.1 什麼是防火牆？

防火牆（Firewall）是一種網路安全系統，其核心功能是監控並控制進出網路的流量。它會根據預先定義的安全規則集（policy），決定是否允許、拒絕或修改特定的網路封包。防火牆是組織網路安全防禦體系中最基礎且不可或缺的組成部分。

*   **定義/核心觀念：** 防火牆是位於受信任內部網路與不受信任外部網路（如網際網路）之間，或用於區隔內部不同安全區域的網路安全設備。它扮演著守門員的角色，依據規則篩選網路流量。
*   **例子：**
    *   **硬體防火牆：** 獨立的實體設備，通常部署在網路邊界，處理高速、大量的流量。例如，Cisco ASA、Fortinet FortiGate、Palo Alto Networks PA 系列等。
    *   **軟體防火牆：** 安裝在作業系統上的應用程式，保護單一主機。例如，Windows Defender 防火牆、Linux 的 `iptables` 或 `firewalld`。
*   **與相鄰概念的關聯：** 防火牆是整個網路安全策略的執行者之一，與路由器（Router）共同負責網路流量的路由與轉發，但額外增添了安全性判斷的功能。

-----

#### #### 1.2 什麼是防火牆政策（使用政策）？

防火牆政策（Firewall Policy），或稱使用政策，是一組詳細定義了防火牆如何運作的規則集。這些規則明確指示防火牆對於特定來源、目的、通訊協定和埠號的網路流量應採取何種動作（允許、拒絕、丟棄或重置）。一個良好的防火牆政策是確保網路安全和業務連續性的關鍵。

*   **定義/核心觀念：** 防火牆政策是指導防火牆行為的「法律」，它由一系列有序的規則（rules）組成，每個規則包含匹配條件（criteria）和對應動作（action）。這些規則通常按順序處理，一旦匹配到第一條規則，後續規則通常就不再評估。
*   **例子：**
    *   **規則範例：**
        1.  `允許 (ALLOW) 來源IP: 內部網路 (192.168.1.0/24) 目的IP: 任何 (ANY) 協定: TCP 埠號: 80, 443 (HTTP/HTTPS)`
            *   **解讀：** 允許內部使用者瀏覽網頁。
        2.  `拒絕 (DENY) 來源IP: 任何 (ANY) 目的IP: 內部伺服器 (192.168.1.10) 協定: TCP 埠號: 22 (SSH)`
            *   **解讀：** 阻止外部對內部伺服器的 SSH 連線。
        3.  `隱性拒絕 (IMPLICIT DENY ALL)`
            *   **解讀：** 這是所有防火牆策略的最後一條，所有不符合前面任何允許規則的流量都將被拒絕。
*   **與相鄰概念的關聯：** 防火牆政策是組織整體資安政策的具體化執行層面。它必須與企業的業務需求、風險評估和法規遵循要求保持一致。

-----

## ### 2. 典型例子與運作模式

#### #### 2.1 防火牆的運作模式

防火牆根據其判斷流量的層次和方法，可分為多種類型。

*   **定義/核心觀念：**
    1.  **封包過濾防火牆 (Packet-Filtering Firewall)：** 最基本的形式，根據封包的表頭資訊（如來源/目的IP位址、埠號、通訊協定）來決定是否放行。
        *   **無狀態 (Stateless)：** 僅檢查單一封包，不追蹤連線狀態。
        *   **有狀態 (Stateful)：** 記錄已建立連線的狀態資訊，只允許屬於已知連線的封包通過，更安全且高效。
    2.  **應用層防火牆 (Application-Layer Firewall / Proxy Firewall)：** 作為應用程式層級的代理，對流量進行更深層次的檢查，理解應用程式協定（如 HTTP、FTP），提供更細緻的控制。
    3.  **次世代防火牆 (Next-Generation Firewall, NGFW)：** 結合了傳統防火牆、入侵防禦系統（IPS）、應用程式識別、使用者識別和深度封包檢測（DPI）等功能，提供更全面的防護。
    4.  **網頁應用程式防火牆 (Web Application Firewall, WAF)：** 專門保護 Web 應用程式，防禦 SQL 注入、跨站指令碼（XSS）等針對應用層的攻擊。
*   **例子/推導：**
    *   **有狀態防火牆運作：** 當內部主機 (Client A) 向外部網頁伺服器 (Server B) 發送一個 TCP SYN 封包時，防火牆會記錄下這個發出連線的請求。當 Server B 回覆 SYN-ACK 封包時，防火牆會因為這個封包與之前的連線請求匹配（屬於已知的連線），而允許其通過。若有攻擊者試圖從外部直接發送 SYN-ACK，防火牆會因為沒有對應的內部發起連線請求而拒絕。
    *   **NGFW 運作：** 一個 NGFW 可以識別出員工正在使用 Facebook 應用程式，即使 Facebook 使用 HTTPS (埠號 443)。管理員可以設定規則，允許特定部門在工作時間訪問 Facebook，或限制其上傳檔案的功能，這些是傳統防火牆難以做到的。
*   **與相鄰概念的關聯：** 防火牆的進化與網路威脅的複雜化息息相關。從基礎的網路層防護，逐步延伸至應用層，並整合了更多資安功能（如 IPS、Anti-Malware），以應對多變的攻擊手法。

-----

#### #### 2.2 防火牆部署範例：DMZ (非軍事區)

*   **定義/核心觀念：** DMZ（Demilitarized Zone）是一種網路架構，用於放置對外提供服務的伺服器（如網頁伺服器、郵件伺服器），將其與受信任的內部網路隔離。這樣做是為了，即使 DMZ 中的伺服器被攻破，攻擊者也難以直接進入內部網路。防火牆在 DMZ 架構中扮演關鍵的隔離和流量控制角色。
*   **例子：**
    *   **三臂（Three-Legged）DMZ 架構：**
        *   一台防火牆連接三個網路介面：
            *   **外部網路（External Network）：** 連接網際網路。
            *   **內部網路（Internal Network）：** 連接公司內部 LAN。
            *   **DMZ 網路：** 連接對外服務的伺服器。
        *   **防火牆策略範例：**
            *   `ALLOW External to DMZ (Web Server) on Port 80, 443`
            *   `DENY External to Internal`
            *   `ALLOW Internal to External (for web browsing, email)`
            *   `ALLOW DMZ (Mail Server) to External (for sending/receiving mail)`
            *   `DENY DMZ to Internal (unless explicitly required, e.g., database access)`
            *   `IMPLICIT DENY ALL`
*   **與相鄰概念的關聯：** DMZ 架構是網路分段（Network Segmentation）的最佳實踐之一，而防火牆是實現這種分段並強制執行安全策略的核心工具。它與零信任（Zero Trust）概念也有關，即不信任任何內外部網路，所有流量都需經過驗證。

-----

## ### 3. 與相鄰概念的關聯

#### #### 3.1 防火牆與入侵偵測/防禦系統 (IDS/IPS)

*   **核心觀念：**
    *   **防火牆 (Firewall)：** 主要基於預設規則（IP、埠號、協定）來允許或拒絕流量。它關注的是「誰」可以「做什麼」。
    *   **入侵偵測系統 (Intrusion Detection System, IDS)：** 監聽網路流量或分析系統日誌，當發現可疑活動或匹配到已知攻擊特徵時，發出警報。IDS 是被動的。
    *   **入侵防禦系統 (Intrusion Prevention System, IPS)：** 是一種更進階的 IDS，不僅能偵測，還能主動阻止或阻斷惡意流量。IPS 是主動的。
*   **關聯：** 防火牆與 IDS/IPS 經常搭配使用，形成多層次的防禦體系。
    *   防火牆提供第一道防線，過濾掉不符合基本安全策略的流量。
    *   IDS/IPS 則對防火牆放行的流量進行更深層次的檢查，查找潛在的惡意攻擊模式。
    *   許多次世代防火牆（NGFW）已經內建了 IPS 功能，提供整合式的防護。

-----

#### #### 3.2 防火牆與 VPN (虛擬私人網路)

*   **核心觀念：**
    *   **VPN：** 透過公共網路（如網際網路）建立加密的安全通道，讓遠端使用者或分支機構能夠安全地存取企業內部資源。
    *   **防火牆：** 控制網路邊界的流量。
*   **關聯：**
    *   防火牆通常用於終止 VPN 連線。遠端用戶的 VPN 客戶端會與防火牆（或整合了 VPN 功能的設備）建立加密通道。
    *   防火牆之後，會根據預先定義的策略，決定哪些來自 VPN 連線的流量可以進入內部網路，哪些資源可以被存取。
    *   防火牆也可以用來限制哪些外部 IP 位址可以嘗試建立 VPN 連線，增加一層安全性。

-----

## ### 4. 進階內容：防火牆策略設計原則

防火牆策略的設計需要遵循一系列最佳實踐，以確保安全性和可用性。

#### #### 4.1 最小權限原則 (Principle of Least Privilege)

*   **核心觀念：** 只允許網路流量具備其執行任務所需的最低權限。這意味著預設應拒絕所有流量，然後僅明確允許必要的流量。
*   **推導：**
    *   **「預設拒絕，明確允許」(Deny All by Default, Permit by Exception)：** 這是最安全的策略，所有不符合特定允許規則的流量都將被阻止。這通常通過在策略列表的末尾設置一條 `DENY ANY ANY ANY` 規則來實現。
    *   避免使用過於寬泛的 `ANY` 規則，除非絕對必要。例如，不應允許 `ANY ANY ANY` 到內部網路的任何埠。
*   **與相鄰概念的關聯：** 這是所有資安設計的基石，適用於使用者權限、系統存取等各個方面。

-----

#### #### 4.2 規則排序與效能

*   **核心觀念：** 防火牆規則通常按照順序從上到下進行評估。一旦流量匹配到某條規則，後續規則通常就不再處理。因此，規則的排序對效能和安全性至關重要。
*   **推導：**
    1.  **最常匹配的規則放前面：** 將預期流量最大、最常用的允許規則放在列表頂部，減少防火牆查找時間。
    2.  **特定的拒絕規則放前面：** 如果有特定的惡意流量或不希望發生的行為，即使它可能符合後面的允許規則，也要將其拒絕規則放在前面。例如，要禁止特定 IP 訪問網頁，應將 `DENY <Bad_IP> ANY Port 80, 443` 放在 `ALLOW ANY ANY Port 80, 443` 之前。
    3.  **一般的允許規則放後面：** 寬泛的允許規則放在後面。
    4.  **隱性拒絕放最後：** `IMPLICIT DENY ALL` 規則永遠在最末端。
*   **與相鄰概念的關聯：** 規則排序影響防火牆的處理效率（效能）和策略的邏輯正確性（安全性）。不當的排序可能導致預期的流量被意外阻止，或不應被允許的流量卻意外通過。

-----

## ### 5. 常見錯誤與澄清

#### #### 5.1 誤解一：防火牆是萬能的

*   **常見錯誤：** 認為只要部署了防火牆，網路就絕對安全，可以高枕無憂。
*   **澄清：** 防火牆是網路安全防禦體系的一部分，但它不是唯一的解決方案。它主要防禦網路層和部分應用層的攻擊。它無法防禦：
    *   透過加密流量傳輸的惡意軟體（如果沒有深度封包檢測）。
    *   內部人員的惡意行為。
    *   應用程式層的漏洞（除非是 WAF）。
    *   社會工程學攻擊。
    *   沒有打補丁的系統漏洞。
*   **建議：** 應結合防火牆、IDS/IPS、防毒軟體、端點保護、安全意識培訓、定期的漏洞掃描和修補等措施，建立多層次、縱深防禦的策略。

-----

#### #### 5.2 誤解二：過於寬鬆或過於嚴格的策略

*   **常見錯誤：**
    *   **過於寬鬆：** 為了方便，設定了大量的 `ALLOW ANY ANY` 或開放了大量不必要的埠，使得攻擊面擴大。
    *   **過於嚴格：** 設定了過於嚴格的策略，導致合法的業務流量被阻止，影響業務運作。
*   **澄清：** 防火牆策略的目標是在安全性和可用性之間取得平衡。
    *   **過於寬鬆**會增加被入侵的風險。
    *   **過於嚴格**會導致業務中斷和使用者不滿。
*   **建議：** 應採用最小權限原則，只允許必要的流量。同時，策略需要定期審查和更新，以適應業務變化，並在測試環境中充分驗證策略的有效性。利用日誌和監控工具來識別被阻止的合法流量，並在確認安全的前提下進行調整。

-----

#### #### 5.3 規則順序的誤解

*   **常見錯誤：** 認為防火牆規則的順序不重要，或者隨意排列。
*   **澄清：** 大多數防火牆設備會從上到下依序處理規則。一旦流量匹配到一條規則，通常會執行該規則的動作並停止處理，即使後面有更具體或衝突的規則。
*   **例子：**
    *   規則 1: `ALLOW 來源 192.168.1.100 目的 ANY 埠 80`
    *   規則 2: `DENY 來源 192.168.1.0/24 目的 ANY 埠 80`
    *   如果按照這個順序，來自 `192.168.1.100` 的 HTTP 流量將會被**允許**，因為它先匹配了規則 1。
    *   如果規則順序顛倒：
        *   規則 1: `DENY 來源 192.168.1.0/24 目的 ANY 埠 80`
        *   規則 2: `ALLOW 來源 192.168.1.100 目的 ANY 埠 80`
        *   則來自 `192.168.1.100` 的 HTTP 流量將會被**拒絕**，因為它先匹配了規則 1。
*   **建議：** 將更具體或需要優先處理（如某些拒絕規則）的規則放在策略列表的前面，而將更一般性的允許規則放在後面，最後是隱性的 `DENY ALL`。

-----

## ### 6. 小練習（附詳解）

#### #### 小練習 1：設計 DMZ 防火牆策略

**情境：** 一家小型公司設有一個內部網路（LAN）、一個對外服務的 DMZ 區域，以及連接外部網際網路。
*   **內部網路 (LAN)：** `10.0.1.0/24`
*   **DMZ 網路：** `10.0.2.0/24`
*   **外部網路 (Internet)：** `ANY`
*   **DMZ 服務：**
    *   網頁伺服器 (`10.0.2.10`)：提供 HTTP (TCP 80) 和 HTTPS (TCP 443) 服務。
    *   DNS 伺服器 (`10.0.2.20`)：供內部和 DMZ 解析網域名稱，並向外部 DNS 轉發請求 (UDP/TCP 53)。
*   **內部需求：**
    *   內部使用者需要瀏覽網際網路。
    *   內部使用者需要透過 DNS 伺服器 (`10.0.2.20`) 解析網域名稱。
    *   內部使用者不應該能直接從網際網路被存取。
*   **外部需求：**
    *   外部使用者需要存取 DMZ 的網頁伺服器。

**任務：** 設計一份防火牆策略，列出所有必要的允許 (ALLOW) 和拒絕 (DENY) 規則，並確保規則的合理順序。最後一條規則應為隱性拒絕。

**步驟：**
1.  列出所有必要的流量方向和通訊埠。
2.  針對每個流量，判斷應該是允許還是拒絕。
3.  根據安全性、效能和最小權限原則，排序這些規則。

---

**詳解 1：**

以下是建議的防火牆策略，按照從上到下的處理順序：

1.  **# 允許外部存取 DMZ 網頁伺服器**
    *   `動作：ALLOW`
    *   `來源：ANY (外部網路)`
    *   `目的：10.0.2.10 (DMZ 網頁伺服器)`
    *   `通訊協定：TCP`
    *   `目的埠：80, 443`
    *   `說明：允許外部使用者存取公司的網頁服務。`

2.  **# 允許內部網路存取外部網路 (網頁、DNS 解析)**
    *   `動作：ALLOW`
    *   `來源：10.0.1.0/24 (內部網路)`
    *   `目的：ANY (外部網路)`
    *   `通訊協定：TCP`
    *   `目的埠：80, 443 (網頁瀏覽)`
    *   `說明：允許內部使用者正常瀏覽網頁。`

3.  **# 允許內部網路使用 DMZ DNS 伺服器**
    *   `動作：ALLOW`
    *   `來源：10.0.1.0/24 (內部網路)`
    *   `目的：10.0.2.20 (DMZ DNS 伺服器)`
    *   `通訊協定：UDP/TCP`
    *   `目的埠：53`
    *   `說明：允許內部主機向 DMZ 的 DNS 伺服器查詢。`

4.  **# 允許 DMZ DNS 伺服器向外部 DNS 查詢**
    *   `動作：ALLOW`
    *   `來源：10.0.2.20 (DMZ DNS 伺服器)`
    *   `目的：ANY (外部網路)`
    *   `通訊協定：UDP/TCP`
    *   `目的埠：53`
    *   `說明：允許 DMZ DNS 伺服器進行遞迴查詢。`

5.  **# 拒絕 DMZ 伺服器主動連線內部網路 (最小權限原則)**
    *   `動作：DENY`
    *   `來源：10.0.2.0/24 (DMZ 網路)`
    *   `目的：10.0.1.0/24 (內部網路)`
    *   `通訊協定：ANY`
    *   `目的埠：ANY`
    *   `說明：這是重要的安全規則，防止DMZ被攻破後，直接攻擊內部網路。通常DMZ伺服器不應主動連線內部。`

6.  **# 拒絕外部網路直接存取內部網路**
    *   `動作：DENY`
    *   `來源：ANY (外部網路)`
    *   `目的：10.0.1.0/24 (內部網路)`
    *   `通訊協定：ANY`
    *   `目的埠：ANY`
    *   `說明：保護內部網路免受外部直接攻擊。`

7.  **# 隱性拒絕所有其他未明確允許的流量**
    *   `動作：DENY`
    *   `來源：ANY`
    *   `目的：ANY`
    *   `通訊協定：ANY`
    *   `目的埠：ANY`
    *   `說明：終止規則，確保所有未明確允許的流量都被阻止。`

-----

#### #### 小練習 2：分析防火牆規則衝突

**情境：** 假設有以下防火牆規則，按照順序從上到下處理。

1.  `ALLOW SRC: 192.168.1.10 DST: ANY PROTO: TCP PORT: 80`
2.  `DENY SRC: 192.168.1.0/24 DST: ANY PROTO: TCP PORT: 80`
3.  `ALLOW SRC: ANY DST: ANY PROTO: UDP PORT: 53`
4.  `DENY SRC: ANY DST: ANY PROTO: ANY PORT: ANY` (隱性拒絕)

**任務：** 分析以下情況，判斷流量會被允許還是拒絕，並說明原因。

1.  來自 `192.168.1.10` 的主機，嘗試連線到外部網頁伺服器的 TCP 80 埠。
2.  來自 `192.168.1.20` 的主機，嘗試連線到外部網頁伺服器的 TCP 80 埠。
3.  來自 `192.168.1.30` 的主機，嘗試連線到外部 DNS 伺服器的 UDP 53 埠。
4.  來自 `172.16.1.5` 的主機，嘗試連線到外部網頁伺服器的 TCP 80 埠。

---

**詳解 2：**

1.  **情況：** 來自 `192.168.1.10` 的主機，嘗試連線到外部網頁伺服器的 TCP 80 埠。
    *   **結果：** **允許 (ALLOW)**
    *   **原因：** 流量首先匹配到**規則 1** (`ALLOW SRC: 192.168.1.10 DST: ANY PROTO: TCP PORT: 80`)。由於規則通常在首次匹配後停止處理，因此該流量會被允許，不會再匹配到規則 2。

2.  **情況：** 來自 `192.168.1.20` 的主機，嘗試連線到外部網頁伺服器的 TCP 80 埠。
    *   **結果：** **拒絕 (DENY)**
    *   **原因：** 流量不匹配規則 1。接著，它會匹配到**規則 2** (`DENY SRC: 192.168.1.0/24 DST: ANY PROTO: TCP PORT: 80`)，因為 `192.168.1.20` 屬於 `192.168.1.0/24` 這個網段。流量被拒絕。

3.  **情況：** 來自 `192.168.1.30` 的主機，嘗試連線到外部 DNS 伺服器的 UDP 53 埠。
    *   **結果：** **允許 (ALLOW)**
    *   **原因：** 流量不匹配規則 1 和規則 2。接著，它會匹配到**規則 3** (`ALLOW SRC: ANY DST: ANY PROTO: UDP PORT: 53`)。流量被允許。

4.  **情況：** 來自 `172.16.1.5` 的主機，嘗試連線到外部網頁伺服器的 TCP 80 埠。
    *   **結果：** **拒絕 (DENY)**
    *   **原因：** 流量不匹配規則 1、規則 2 和規則 3。最終，它會匹配到**規則 4** (`DENY SRC: ANY DST: ANY PROTO: ANY PORT: ANY`)，即隱性拒絕。流量被拒絕。

-----

## ### 7. 延伸閱讀與參考

*   **網路安全基礎：** 深入了解 TCP/IP 協定堆疊、路由、交換等基本概念，有助於更好地理解防火牆的工作原理。
*   **RFCs (Request for Comments)：**
    *   RFC 791 (IP - Internet Protocol)
    *   RFC 793 (TCP - Transmission Control Protocol)
    *   RFC 1918 (Address Allocation for Private Internets) - 了解私有 IP 位址和 NAT。
*   **防火牆廠商文件：**
    *   Cisco Adaptive Security Appliance (ASA) 文檔
    *   Fortinet FortiGate 系列產品文檔
    *   Palo Alto Networks Next-Generation Firewall 文檔
*   **書籍：**
    *   "Network Security Essentials: Applications and Standards" by William Stallings
    *   "The Tao of Network Security Monitoring: Beyond IDS" by Richard Bejtlich
*   **線上資源：**
    *   資安相關新聞網站和部落格，追蹤最新的威脅和防火牆技術發展。
    *   OWASP (Open Web Application Security Project) - 了解 Web 應用程式安全和 WAF 的重要性。
*   **零信任架構 (Zero Trust Architecture)：** 了解現代網路安全設計理念，如何將防火牆的概念擴展到更細粒度的存取控制和持續驗證。